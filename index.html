<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrol Palet Hanwa</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font default dan dark mode (Tema Hijau/Hitam/Putih) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #18181b; /* Warna background gelap (mendekati hitam - Zinc 900) */
            color: #ffffff; /* Warna teks terang (Putih) */
        }
        /* Style untuk kartu menu */
        .menu-card {
            background-color: #27272a; /* Zinc 800 */
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .menu-card:hover {
            background-color: #3f3f46; /* Zinc 700 */
            transform: translateY(-3px);
            border-color: #22c55e; /* Border hijau (Green 500) saat hover */
        }
        .icon {
            color: #9ca3af; /* Warna ikon default (abu-abu terang) */
            transition: color 0.3s ease-in-out;
        }
        .menu-card:hover .icon {
            color: #22c55e; /* Warna ikon hijau (Green 500) saat hover */
        }
        /* Style untuk App View */
        .app-view {
            background-color: #18181b; /* Zinc 900 */
            color: #ffffff; /* Putih */
            min-height: 100vh;
        }
        /* (BARU) Style untuk Halaman Login */
        .login-view {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .login-card {
            background-color: #27272a; /* Zinc 800 */
            border-top: 4px solid #22c55e; /* Aksen hijau */
        }
        
        /* Style untuk Tabel */
        .pallet-table {
            background-color: #27272a; /* Zinc 800 */
        }
        .pallet-table th {
            /* Styling header yang ditingkatkan */
            background-color: #18181b; /* Zinc 900 (Lebih gelap) */
            color: #9ca3af;
        }
        /* Baris header (judul) */
        .pallet-table thead tr:first-child th {
            border-bottom: 2px solid #22c55e; /* Garis bawah hijau (Green 500) */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Baris filter (input) */
        .pallet-table thead tr:nth-child(2) th {
            background-color: #18181b; /* Pastikan background sama */
            border-bottom: 1px solid #3f3f46; /* Garis bawah abu-abu */
            position: sticky;
            top: 37px; /* (py-3 + text-xs) ~ 12px+12px+13px. Sesuaikan jika perlu */
            z-index: 10;
        }
        .pallet-table tr:nth-child(even) {
            background-color: #3f3f46; /* Zinc 700 */
        }
        /* Kelas warna bersyarat (Tetap sama) */
        .color-green { color: #34d399; } /* Tailwind green-400 */
        .color-orange { color: #f97316; } /* Tailwind orange-600 */
        .color-red { color: #f87171; } /* Tailwind red-400 */
        /* Style untuk tombol */
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); /* Bayangan hijau */
        }
        /* Style untuk ID Palet Card */
        .id-card {
            background-color: #18181b; /* Zinc 900 */
            border: 1px solid #22c55e; /* Border hijau (Green 500) */
            transition: all 0.2s;
            cursor: pointer;
            padding: 0.5rem 0.75rem; 
            font-size: 0.875rem; /* text-sm */
        }
        .id-card.selected {
            background-color: #22c55e; /* Warna hijau (Green 500) jika terpilih */
            color: #18181b; /* Teks gelap agar kontras di atas hijau */
            border-color: #16a34a; /* Green 600 */
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
        }
        /* Style untuk display ID yang dipilih */
        .selected-id-tag {
            background-color: #22c55e; /* Green 500 */
            color: #18181b; /* Teks gelap */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container" class="min-h-screen">
        <!-- Konten akan dimuat di sini oleh JavaScript -->
    </div>

    <!-- Firebase, Navigasi, dan Logic JavaScript -->
    <script type="module">
        // --- 1. SETUP FIREBASE (MANDATORI SESUAI ATURAN PLATFORM) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        
        // --- DATA STATE GLOBAL ---
        let currentUser = null; // (BARU) Menyimpan data user { username, role }
        let masterPalletData = []; // Menyimpan semua data Master Palet
        let masterPalletHeaders = []; // Menyimpan header master palet
        let historyPalletData = []; // Menyimpan data history untuk filter
        let historyPalletHeaders = []; // Menyimpan header tabel history
        let selectedPalletIds = []; // Menyimpan ID Palet yang sedang dipilih untuk transaksi

        /**
         * (MODIFIKASI) Inisialisasi Firebase
         * Dibuat async dan mengembalikan Promise.
         * Tidak lagi me-render app, hanya setup auth.
         */
        async function initializeFirebase() {
            if (auth) return; // Sudah diinisialisasi

            return new Promise((resolve) => {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    const authCallback = (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase Auth State Changed. User ID:", userId);
                            resolve();
                        } else {
                            // Jika tidak ada token, login anonim
                            signInAnonymously(auth).then(cred => {
                                userId = cred.user.uid;
                                console.log("Firebase Auth State Changed (Anonymous). User ID:", userId);
                                resolve();
                            }).catch(err => {
                                 console.error("Anonymous sign-in failed:", err);
                                 userId = 'guest-' + crypto.randomUUID().substring(0, 8);
                                 resolve(); // Selesaikan juga jika gagal
                            });
                        }
                    };
                    
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        unsubscribe(); // Hentikan listener
                        
                        if (initialAuthToken) {
                            signInWithCustomToken(auth, initialAuthToken).then(cred => {
                                userId = cred.user.uid;
                                console.log("Firebase Auth (Custom Token). User ID:", userId);
                                resolve();
                            }).catch(err => {
                                console.warn("Custom token failed, trying anonymous.", err);
                                authCallback(null); // Fallback ke anonim
                            });
                        } else {
                            authCallback(user); // Panggil handler standar
                        }
                    });
                    
                } catch (error) {
                    console.error("Kesalahan saat inisialisasi Firebase:", error);
                    userId = 'guest-error-' + crypto.randomUUID().substring(0, 8);
                    resolve(); // Selesaikan promise agar app tidak macet
                }
            });
        }
        
        // --- 2. NAVIGASI STATE ---
        function navigate(page) {
            localStorage.setItem('currentPage', page);
            // Bersihkan state ID Palet saat pindah halaman
            if (page !== 'transaksiPalet') {
                selectedPalletIds = [];
            }
            renderApp(page);
        }

        // --- 3. RENDERING UTAMA ---
        /**
         * (MODIFIKASI) Render App
         * Sekarang memiliki 'login' dan proteksi halaman.
         */
        function renderApp(page) {
            const container = document.getElementById('app-container');
            
            // (BARU) Proteksi halaman: Jika halaman bukan login dan user tidak ada, paksa ke login
            if (page !== 'login' && !currentUser) {
                console.log("User not authenticated. Redirecting to login.");
                page = 'login';
            }
            
            container.innerHTML = ''; // Bersihkan konten

            switch (page) {
                // (BARU) Halaman Login
                case 'login':
                    container.innerHTML = createLoginView();
                    break;
                case 'masterPalet':
                    container.innerHTML = createMasterPalletView();
                    fetchMasterPalletData(); // Panggil fungsi fetch data
                    break;
                case 'stockPalet':
                    container.innerHTML = createStockPalletView(); // Panggil view baru
                    fetchStockPalletData(); // Panggil fungsi fetch data baru
                    break;
                case 'transaksiPalet':
                    selectedPalletIds = []; 
                    container.innerHTML = createTransactionPalletView();
                    fetchMasterDataForTransaction(); // Panggil fungsi fetch data Master baru
                    break;
                case 'historyPalet':
                    container.innerHTML = createHistoryPalletView();
                    fetchHistoryPalletData();
                    break;
                case 'stoPalet':
                    container.innerHTML = createPlaceholderView('STO Palet', 'Stock Taking Palet');
                    break;
                case 'dashboard':
                default:
                    container.innerHTML = createDashboardView();
                    break;
            }
        }
        
        // --- HELPER: Mendapatkan ID pesan status berdasarkan judul ---
        function getStatusMessageId(title) {
            return `status-message-${title.toLowerCase().replace(/\s/g, '-')}`;
        }


        // --- 4. TAMPILAN DASHBOARD (Menu Utama) ---
        /**
         * (MODIFIKASI) createDashboardView
         * Menampilkan username/role dan tombol logout.
         */
        function createDashboardView() {
            // Fallback jika currentUser tiba-tiba null
            const username = currentUser ? currentUser.username : '...';
            const role = currentUser ? currentUser.role : '...';

            return `
                <div class="p-6">
                    <header class="flex justify-between items-center mb-10">
                        <div class="flex items-center">
                            <svg class="w-8 h-8 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10M10 7v10M16 7v10M20 4v16a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h12a2 2 0 012 2z"></path>
                            </svg>
                            <h1 class="text-3xl font-bold text-gray-100 uppercase">Control Palet Hanwa</h1>
                        </div>
                        <!-- (MODIFIKASI) Tampilan User dan Tombol Logout -->
                        <div class="flex items-center text-sm text-gray-400">
                            <span class="mr-3 hidden sm:inline">User: <span class="font-bold text-green-400">${username}</span> (${role})</span>
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.939 13.939 0 0112 16c2.585 0 5.043.682 7.079 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <!-- (BARU) Tombol Logout -->
                            <button onclick="handleLogout()" title="Logout" class="ml-2 p-1 rounded-full hover:bg-zinc-700 transition">
                                <svg class="w-6 h-6 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                            </button>
                        </div>
                    </header>

                    <!-- Grid Menu Utama (5 kolom) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 max-w-7xl mx-auto">
                        
                        <!-- MASTER PALET -->
                        <div onclick="navigate('masterPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10m-4-11l-4 2.12V17M16 12l4 2.12V17"></path>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Master Palet</h2>
                                <p class="text-sm text-gray-400">Data Induk Palet</p>
                            </div>
                        </div>

                        <!-- STOCK PALET -->
                        <div onclick="navigate('stockPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 12V3h16v9m-4-4l-4 4-4-4m8 8h-8v4h8v-4z"></path>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Stock Palet</h2>
                                <p class="text-sm text-gray-400">Ringkasan Stok Palet</p>
                            </div>
                        </div>

                        <!-- TRANSAKSI PALET -->
                        <div onclick="navigate('transaksiPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14m-1.447 3.382l-.675.337M4 12a7 7 0 1014 0 7 7 0 01-14 0z"></path>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Transaksi Palet</h2>
                                <p class="text-sm text-gray-400">Log Pergerakan Palet</p>
                            </div>
                        </div>

                        <!-- STO PALET -->
                        <div onclick="navigate('stoPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold uppercase mb-1 text-gray-100">STO Palet</h2>
                                <p class="text-sm text-gray-400">Stock Taking Palet</p>
                            </div>
                        </div>
                        
                        <!-- HISTORY PALET -->
                        <div onclick="navigate('historyPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold uppercase mb-1 text-gray-100">History Palet</h2>
                                <p class="text-sm text-gray-400">Log Transaksi Palet</p>
                            </div>
                        </div>

                    </div>
                    
                    <footer class="mt-12 text-center text-xs text-grey-600">
                        Aplikasi Kontrol Palet (v3.0) - Elaborated by SOPARI-HSSI0293
                    </footer>
                </div>
            `;
        }
        
        // --- 5. SETUP GOOGLE SHEET URLS ---
        
        const GOOGLE_SHEET_ID = '1YiIDIa0Ysi-O0k4askOtd8Qf66KnQuJxlLMngDlqM1A'; // GANTI dengan ID Google Sheet Anda
        const MASTER_SHEET_NAME = 'MASTER PALET'; 
        const STOCK_SHEET_NAME = 'Ringkasan Stok Palet'; 
        const TRANSACTION_SHEET_NAME = 'Log Transaksi Palet Batch'; 
        const USERCONTROL_SHEET_NAME = 'Usercontrol'; // (BARU) Sheet untuk login
        const RANGE = 'A:H'; 

        const MASTER_PALLET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${MASTER_SHEET_NAME}&range=${RANGE}`;
        const STOCK_PALLET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${STOCK_SHEET_NAME}&range=${RANGE}`;
        const HISTORY_PALLET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${TRANSACTION_SHEET_NAME}&range=${RANGE}`;
        // (BARU) URL untuk User Control (Range A:C untuk Username, Password, Role)
        const USERCONTROL_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${USERCONTROL_SHEET_NAME}&range=A:C`;
        
        const MOCK_API_DEPLOY_URL = 'https://script.google.com/macros/s/AKfycbwiq9RP1jZykmw8a4W1PNgoUgfekOxCkAiHhnLtzFX8YB1I8TTPnzgkhNYQZH6I-MZJ/exec'; 

        // --- 6. FUNGSI FETCH DATA UNIVERSAL (Read Only) ---
        
        async function fetchGoogleSheetData(url, statusEl, errorBoxEl, successCallback) {
            if (statusEl) statusEl.textContent = 'Memuat data...';
            if (errorBoxEl) errorBoxEl.classList.add('hidden');

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Status ${response.status}`);
                
                const text = await response.text();
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);
                
                if (data.status !== 'ok') {
                    throw new Error(`Query error: ${data.errors ? data.errors[0].message : 'Unknown error'}`);
                }

                const parsedData = parseGVizData(data);
                successCallback(parsedData, statusEl);
                
            } catch (error) {
                console.error("Kesalahan saat mengambil data Google Sheet:", error);
                if (statusEl) statusEl.textContent = 'Gagal memuat data.';
                if (errorBoxEl) {
                    errorBoxEl.textContent = `ðŸš¨ GAGAL MEMUAT DATA: ${error.message}. Pastikan ID Sheet, Nama Sheet, dan Izin akses publik sudah benar.`;
                    errorBoxEl.classList.remove('hidden');
                }
                // (BARU) Melempar error agar handleLogin bisa menangkapnya
                throw error;
            }
        }
        
        /**
         * Mengurai struktur data GViz menjadi array objek JavaScript yang sederhana.
         */
        function parseGVizData(data) {
            const columns = data.table.cols.map(col => ({
                id: col.id,
                label: col.label || col.id  
            })).filter(col => col.label); // Hilangkan kolom tanpa label

            const rows = data.table.rows;
            const result = [];

            if (rows.length > 0) {
                for (const row of rows) {
                    const rowObject = {};
                    for (let i = 0; i < columns.length; i++) {
                        const colLabel = columns[i].label;
                        rowObject[colLabel] = row.c[i] ? (row.c[i].f || row.c[i].v) : '';
                    }
                    result.push(rowObject);
                }
            }
            
            return { data: result, headers: columns.map(c => c.label) };
        }

        // --- (BARU) LOGIC UNTUK LOGIN ---
        
        /**
         * (BARU) Membuat tampilan Login
         */
        function createLoginView() {
            return `
                <div class="login-view app-view">
                    <div class="login-card w-full max-w-sm p-8 rounded-lg shadow-2xl">
                        <div class="flex items-center justify-center mb-6">
                            <svg class="w-10 h-10 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10M10 7v10M16 7v10M20 4v16a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h12a2 2 0 012 2z"></path>
                            </svg>
                            <h1 class="text-2xl font-bold text-gray-100 uppercase">Control Palet</h1>
                        </div>
                        
                        <form id="login-form" onsubmit="handleLogin(event)">
                            <div class="mb-4">
                                ${createFormInput('Username', 'loginUsername', 'text', true, 'Masukkan username...')}
                            </div>
                            <div class="mb-6">
                                ${createFormInput('Password', 'loginPassword', 'password', true, 'Masukkan password...')}
                            </div>
                            
                            <!-- (BARU) Kotak Pesan Error Login -->
                            <div id="login-error-message" class="hidden p-3 rounded-lg text-sm mb-4 font-medium bg-red-800 text-white" role="alert"></div>

                            <button type="submit" id="login-submit-btn" class="btn-primary w-full bg-green-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-700 transition">
                                Login
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }
        
        /**
         * (BARU) Handle proses login
         */
        async function handleLogin(event) {
            event.preventDefault();
            const usernameEl = document.getElementById('loginUsername');
            const passwordEl = document.getElementById('loginPassword');
            const errorBox = document.getElementById('login-error-message');
            const submitBtn = document.getElementById('login-submit-btn');

            if (!usernameEl || !passwordEl || !errorBox || !submitBtn) return;
            
            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            
            if (!username || !password) {
                errorBox.textContent = "Username dan Password tidak boleh kosong.";
                errorBox.classList.remove('hidden');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = "Memverifikasi...";
            errorBox.classList.add('hidden');

            try {
                // (BARU) Callback untuk memproses data user
                const loginCheckCallback = async (parsedData, statusEl) => {
                    // (MODIFIKASI) Ambil 'data' dan 'headers'
                    const { data, headers } = parsedData;
                    
                    // (MODIFIKASI) Validasi jumlah header
                    if (headers.length < 3) {
                        errorBox.textContent = "Format sheet 'Usercontrol' salah. Butuh 3 kolom (Username, Password, Role).";
                        errorBox.classList.remove('hidden');
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Login";
                        return;
                    }

                    // (MODIFIKASI) Dapatkan nama kolom dari URUTAN, bukan hardcode
                    const userCol = headers[0]; // Kolom A (cth: "Username" atau "username")
                    const passCol = headers[1]; // Kolom B (cth: "Password" atau "password")
                    const roleCol = headers[2]; // Kolom C (cth: "Role" atau "role")

                    const foundUser = data.find(user => 
                        // (MODIFIKASI) Gunakan nama kolom dinamis
                        String(user[userCol] || '').trim() === username &&
                        String(user[passCol] || '').trim() === password
                    );
                    
                    if (foundUser) {
                        // SUKSES LOGIN
                        console.log("Login sukses:", foundUser);
                        currentUser = { 
                            // (MODIFIKASI) Gunakan nama kolom dinamis
                            username: String(foundUser[userCol]).trim(), 
                            role: String(foundUser[roleCol] || 'User').trim() 
                        };
                        
                        // Simpan di session storage
                        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        // Inisialisasi Firebase (penting untuk userId)
                        await initializeFirebase();
                        
                        // Render dashboard
                        renderApp('dashboard');
                        
                    } else {
                        // GAGAL LOGIN
                        errorBox.textContent = "Username atau Password salah.";
                        errorBox.classList.remove('hidden');
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Login";
                    }
                };
                
                // Ambil data dari sheet 'Usercontrol'
                await fetchGoogleSheetData(USERCONTROL_URL, null, errorBox, loginCheckCallback);

            } catch (error) {
                console.error("Gagal fetch data user:", error);
                errorBox.textContent = "Gagal terhubung ke server. Periksa koneksi Anda.";
                errorBox.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = "Login";
            }
        }
        
        /**
         * (BARU) Handle proses logout
         */
        function handleLogout() {
            console.log("Logging out...");
            // Hapus data sesi
            sessionStorage.removeItem('currentUser');
            localStorage.removeItem('currentPage');
            currentUser = null;
            
            // Reset state Firebase
            if (auth) {
                signOut(auth);
            }
            auth = null;
            db = null;
            userId = null;
            
            // Reset data cache
            masterPalletData = [];
            masterPalletHeaders = [];
            historyPalletData = [];
            historyPalletHeaders = [];
            
            // Kembali ke login
            renderApp('login');
        }
        
        /**
         * (BARU) Memeriksa status login saat memuat halaman
         */
        async function checkSessionAndRender() {
            const storedUser = sessionStorage.getItem('currentUser');
            
            if (storedUser) {
                console.log("Sesi ditemukan, melanjutkan...");
                currentUser = JSON.parse(storedUser);
                // Inisialisasi Firebase
                await initializeFirebase();
                // Render halaman terakhir atau dashboard
                renderApp(localStorage.getItem('currentPage') || 'dashboard');
            } else {
                console.log("Tidak ada sesi, menampilkan login.");
                // Hanya render login, tidak perlu tunggu Firebase
                renderApp('login');
            }
        }


        // --- 7. LOGIC UNTUK MASTER PALET (Tabel Detail) ---
        const MASTER_PALET_TITLE = 'Master Palet';

        function createMasterPalletView() {
            return `
                <div id="master-pallet-view" class="app-view p-6">
                    ${createHeader(MASTER_PALET_TITLE, 'dashboard')}

                    <h2 class="text-xl font-bold text-gray-300 mb-3 border-b border-gray-800 pb-2">Detail Data Palet</h2>
                    <div id="table-container" class="shadow-lg rounded-xl overflow-x-auto">
                        <table id="pallet-table-master" class="pallet-table min-w-full divide-y divide-gray-700 rounded-xl">
                            <thead class="bg-gray-800">
                                <!-- Konten header (judul dan filter) akan diisi oleh fetchMasterPalletData -->
                            </thead>
                            <tbody class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>

                    <div id="error-box-master" class="hidden mt-4 p-4 rounded-lg bg-red-800 text-white font-semibold"></div>
                </div>
            `;
        }

        async function fetchMasterPalletData() {
            const statusMessageEl = document.getElementById(getStatusMessageId(MASTER_PALET_TITLE)); 
            const tableHeadEl = document.querySelector('#pallet-table-master thead');
            const tableBodyEl = document.querySelector('#pallet-table-master tbody');
            const errorBoxEl = document.getElementById('error-box-master');
            
            if (!statusMessageEl || !tableHeadEl || !tableBodyEl) return; 
            
            tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';

            await fetchGoogleSheetData(MASTER_PALLET_URL, statusMessageEl, errorBoxEl, (parsedData, statusEl) => {
                const { data, headers } = parsedData;
                masterPalletData = data; 
                masterPalletHeaders = headers; // Simpan header di state global
                
                if (data.length === 0) {
                    statusEl.textContent = "Data tidak ditemukan.";
                    tableHeadEl.innerHTML = '';
                    tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data Master Palet yang tersedia.</td></tr>';
                    return;
                }

                statusEl.textContent = `${data.length} Data Palet Ditemukan`;

                // Render baris header dan baris filter
                // Baris 1: Headers
                const headerRow = `
                    <tr class="bg-gray-800">
                        ${headers.map(header => 
                            `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-green-300">${header}</th>`
                        ).join('')}
                    </tr>
                `;

                // Baris 2: Filters
                const filterRow = `
                    <tr class="bg-gray-800">
                        ${headers.map(header => `
                            <th class="p-1 align-top">
                                <input type="text" 
                                       class="w-full px-2 py-1 text-xs bg-zinc-700 border border-zinc-600 rounded text-white placeholder-zinc-400 focus:ring-green-500 focus:border-green-500 master-filter-input" 
                                       placeholder="Filter..."
                                       data-header="${header}"
                                       onkeyup="filterMasterPalletTable()">
                            </th>
                        `).join('')}
                    </tr>
                `;
                
                tableHeadEl.innerHTML = headerRow + filterRow;

                // Panggil fungsi render body terpisah
                renderMasterPalletTableBody(data);
            });
        }
        
        /**
         * Fungsi terpisah untuk me-render <tbody> tabel Master Palet
         */
        function renderMasterPalletTableBody(data) {
            const tableBodyEl = document.querySelector('#pallet-table-master tbody');
            if (!tableBodyEl) return;
            
            const headersCount = masterPalletHeaders.length || 10;

            if (data.length === 0) {
                tableBodyEl.innerHTML = `<tr><td colspan="${headersCount}" class="text-center py-4 text-gray-500">Data tidak ditemukan untuk filter ini.</td></tr>`;
                return;
            }

            tableBodyEl.innerHTML = data.map((item, index) => {
                const status = item['Status'] || '';
                const lokasi = item['Lokasi'] || '';

                const rowColorClass = getRowColorClass(status, lokasi);
                const rowBgClass = (index % 2 === 0 ? 'bg-zinc-800' : 'bg-zinc-700');
                
                return `
                    <tr class="${rowBgClass} ${rowColorClass}">
                        ${masterPalletHeaders.map(header => 
                            `<td class="px-6 py-3 whitespace-nowrap text-sm">${item[header] || '-'}</td>`
                        ).join('')}
                    </tr>
                `;
            }).join('');
        }
        
        /**
         * Fungsi untuk memfilter dan me-render ulang tabel master palet
         */
        function filterMasterPalletTable() {
            const filterInputs = document.querySelectorAll('#pallet-table-master .master-filter-input');
            const filters = {};

            // 1. Kumpulkan semua nilai filter
            filterInputs.forEach(input => {
                const header = input.dataset.header;
                const value = input.value.toUpperCase().trim();
                if (value) {
                    filters[header] = value;
                }
            });

            const filterKeys = Object.keys(filters);
            let filteredData = masterPalletData; // Mulai dengan data lengkap

            // 2. Terapkan filter jika ada
            if (filterKeys.length > 0) {
                filteredData = masterPalletData.filter(item => {
                    // Periksa apakah item lolos SEMUA filter
                    return filterKeys.every(header => {
                        const itemValue = String(item[header] || '').toUpperCase();
                        return itemValue.includes(filters[header]);
                    });
                });
            }
            
            // 3. Render ulang body tabel dengan data yang sudah difilter
            renderMasterPalletTableBody(filteredData);
        }

        function getRowColorClass(status, lokasi) {
            const s = String(status).toUpperCase().trim();
            const l = String(lokasi).toUpperCase().trim();

            if (s === 'KOSONG' && l === 'AREA PALET') {
                return 'color-green'; 
            }
            if (s === 'TERISI' && (l === 'AREA PRODUCT' || l === 'GUDANG')) {
                return 'color-orange'; 
            }
            if (s === 'TERISI' && l === 'CUSTOMER') {
                return 'color-red'; 
            }
            return 'text-gray-200'; 
        }
        
        // --- 8. LOGIC UNTUK STOCK PALET (Ringkasan/Total) ---
        const STOCK_PALET_TITLE = 'Stock Palet';

        function createStockPalletView() {
            return `
                <div id="stock-pallet-view" class="app-view p-6">
                    ${createHeader(STOCK_PALET_TITLE, 'dashboard')}

                    <h2 class="text-xl font-bold text-gray-300 mb-4 border-b border-gray-800 pb-2">Ringkasan Stok Palet Berdasarkan Lokasi</h2>
                    
                    <div id="stock-summary-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <!-- Kartu akan diisi di sini -->
                    </div>

                    <h2 class="text-xl font-bold text-gray-300 mb-3 border-b border-gray-800 pb-2">Detail Data Ringkasan</h2>
                    <div id="table-container-stock" class="shadow-lg rounded-xl overflow-x-auto">
                        <table id="pallet-table-stock" class="pallet-table min-w-full divide-y divide-gray-700 rounded-xl">
                            <thead class="bg-gray-800"><tr></tr></thead>
                            <tbody class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>

                    <div id="error-box-stock" class="hidden mt-4 p-4 rounded-lg bg-red-800 text-white font-semibold"></div>
                </div>
            `;
        }

        async function fetchStockPalletData() {
            const statusMessageEl = document.getElementById(getStatusMessageId(STOCK_PALET_TITLE));
            const summaryContainerEl = document.getElementById('stock-summary-container');
            const tableHeaderEl = document.querySelector('#pallet-table-stock thead tr');
            const tableBodyEl = document.querySelector('#pallet-table-stock tbody');
            const errorBoxEl = document.getElementById('error-box-stock');
            
            if (!statusMessageEl || !summaryContainerEl || !tableHeaderEl || !tableBodyEl) return; 

            summaryContainerEl.innerHTML = createSummaryCardPlaceholder('Memuat...', 'Total Palet Hanwa');
            tableHeaderEl.innerHTML = '';
            tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';

            
            await fetchGoogleSheetData(STOCK_PALLET_URL, statusMessageEl, errorBoxEl, (parsedData, statusEl) => {
                const { data, headers } = parsedData;
                
                if (data.length === 0) {
                    statusEl.textContent = "Data ringkasan stok tidak ditemukan.";
                    tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data Ringkasan Stok Palet yang tersedia.</td></tr>';
                    summaryContainerEl.innerHTML = createSummaryCardPlaceholder(0, 'Total Palet Hanwa');
                    return;
                }

                statusEl.textContent = `${data.length} Baris Ringkasan Ditemukan`;

                const totalIndex = headers.length > 0 ? headers.findIndex(h => h.toUpperCase().includes('TOTAL')) : -1;
                let grandTotal = 0;
                
                data.forEach(item => {
                    const totalValue = totalIndex >= 0 ? parseFloat(String(Object.values(item)[totalIndex]).replace(/[^0-9.,]/g, '').replace(',', '.') || 0) : 0;
                    grandTotal += totalValue;
                });

                summaryContainerEl.innerHTML = createSummaryCard(grandTotal.toLocaleString('id-ID'), 'Total Palet Hanwa', 'text-green-400');

                tableHeaderEl.innerHTML = headers.map(header => 
                    `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-green-300">${header}</th>`
                ).join('');

                tableBodyEl.innerHTML = data.map((item, index) => {
                    const rowBgClass = (index % 2 === 0 ? 'bg-zinc-800' : 'bg-zinc-700');
                    return `
                        <tr class="${rowBgClass} text-gray-200">
                            ${headers.map(header => 
                                `<td class="px-6 py-3 whitespace-nowrap text-sm">${item[header] || '-'}</td>`
                            ).join('')}
                        </tr>
                    `;
                }).join('');
            });
        }

        // --- 9. LOGIC UNTUK TRANSAKSI PALET (Form Input) ---
        const TRANSACTION_PALET_TITLE = 'Transaksi Palet';

        function createTransactionPalletView() {
            const today = new Date().toISOString().split('T')[0];
            
            return `
                <div id="transaction-pallet-view" class="app-view p-6 max-w-4xl mx-auto">
                    ${createHeader(TRANSACTION_PALET_TITLE, 'dashboard')}

                    <div class="bg-zinc-800 p-6 sm:p-8 rounded-xl shadow-2xl">
                        <p class="text-sm text-gray-400 mb-6">
                            Gunakan formulir ini untuk mencatat pergerakan <span class="font-bold text-green-300">beberapa</span> palet sekaligus.
                        </p>

                        <div id="transaction-message-box" class="hidden p-3 rounded-lg text-sm mb-4 font-medium" role="alert"></div>

                        <form id="transaction-form" onsubmit="submitTransaction(event)">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                
                                <div>
                                    ${createFormSelect('Nama Palet', 'namaPalet', [], true, 'updateSizePallet')}
                                </div>
                                
                                <div>
                                    ${createFormSelect('Size Palet', 'sizePalet', [], true, 'renderPalletIdCards')}
                                </div>

                                <div>
                                    ${createFormInput('Tanggal Transaksi', 'tanggalTransaksi', 'date', true, '', today)}
                                </div>
                                
                                <div>
                                    ${createFormSelect('Jenis Transaksi', 'jenisTransaksi', [
                                        { value: 'DIGUNAKAN PRODUKSI', label: 'di Gunakan Produksi' },
                                        { value: 'KELUAR HANWA', label: 'Keluar Hanwa (Pengiriman)' },
                                        { value: 'MASUK HANWA', label: 'Masuk Hanwa (Penerimaan)' }
                                    ], true)}
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label for="keterangan" class="block text-sm font-medium text-gray-300 mb-1">Keterangan (Opsional)</label>
                                    <textarea id="keterangan" name="keterangan" rows="3" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-green-500 focus:border-green-500"></textarea>
                                </div>
                            </div>

                            <div class="mt-8">
                                <h3 class="text-lg font-bold text-gray-300 mb-3 border-b border-gray-700 pb-1">1. Pilih ID Palet Tersedia <span id="selected-count" class="text-green-400 text-sm font-normal">(0 Palet Dipilih)</span></h3>
                                <div id="pallet-id-card-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3">
                                    <p class="text-gray-500 col-span-full" id="id-card-status">Pilih Nama Palet dan Size Palet terlebih dahulu.</p>
                                </div>
                            </div>
                            
                            <div class="mt-6 p-4 bg-gray-700 rounded-lg border border-green-500">
                                <h4 class="text-sm font-semibold text-green-300 mb-2">2. ID Palet yang akan Diproses:</h4>
                                <div id="selected-ids-display" class="flex flex-wrap gap-2 min-h-[2.5rem]">
                                    <span class="text-gray-400 text-sm">Belum ada palet yang dipilih.</span>
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-4 border-t border-gray-700 flex justify-end">
                                <button type="submit" id="submit-btn" class="btn-primary bg-green-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-700 transition">
                                    <span id="submit-btn-text">Kirim Transaksi</span> (<span id="submit-count">0</span> Palet)
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        async function fetchMasterDataForTransaction() {
            const statusMessageEl = document.getElementById(getStatusMessageId(TRANSACTION_PALET_TITLE)); 
            const namaPaletEl = document.getElementById('namaPalet');
            
            if (!namaPaletEl) return;
            
            namaPaletEl.innerHTML = '<option value="" disabled selected>Memuat data...</option>';
            namaPaletEl.disabled = true;

            const updateMasterData = (parsedData, statusEl) => {
                const { data } = parsedData;
                masterPalletData = data; 
                
                if (data.length === 0) {
                    if(statusEl) statusEl.textContent = "Data Master Palet kosong. Transaksi dibatalkan.";
                    return;
                }

                const uniqueNames = [...new Set(data.map(item => String(item['Nama Palet']).trim()).filter(name => name))];
                const options = uniqueNames.map(name => ({ value: name, label: name }));
                namaPaletEl.innerHTML = createOptionHtml(options, 'Pilih Nama Palet');
                namaPaletEl.disabled = false;
                if(statusEl) statusEl.textContent = `Data Master siap (${data.length} entri)`;
            };

            await fetchGoogleSheetData(MASTER_PALLET_URL, statusMessageEl, {classList:{add:()=>{}, remove:()=>{}}}, updateMasterData);
        }
        
        function updateSizePallet() {
            const namaPaletEl = document.getElementById('namaPalet');
            const sizePaletEl = document.getElementById('sizePalet');
            
            if (!namaPaletEl || !sizePaletEl) return;
            
            const namaPalet = namaPaletEl.value.trim();
            
            sizePaletEl.innerHTML = createOptionHtml([], 'Pilih Size Palet');
            sizePaletEl.disabled = true;
            
            selectedPalletIds = []; 
            updateSelectedDisplay();
            renderPalletIdCards(); 

            if (!namaPalet) return;

            const filteredBySize = masterPalletData.filter(item => 
                String(item['Nama Palet']).trim() === namaPalet
            );
            
            const uniqueSizes = [...new Set(
                filteredBySize.map(item => String(item['Size']).trim()).filter(size => size)
            )];
            
            const options = uniqueSizes.map(size => ({ value: size, label: size }));
            
            if (options.length === 0) {
                 sizePaletEl.innerHTML = createOptionHtml([], 'Tidak ada Size Palet tersedia');
                 return;
            }

            sizePaletEl.innerHTML = createOptionHtml(options, 'Pilih Size Palet');
            sizePaletEl.disabled = false;
        }

        function renderPalletIdCards() {
            const namaPaletEl = document.getElementById('namaPalet');
            const sizePaletEl = document.getElementById('sizePalet');
            const container = document.getElementById('pallet-id-card-container');
            
            if (!container) return; 
            
            const namaPalet = namaPaletEl ? namaPaletEl.value.trim() : '';
            const sizePalet = sizePaletEl ? sizePaletEl.value.trim() : '';
            
            container.innerHTML = `<p class="text-gray-500 col-span-full" id="id-card-status">Memfilter ID Palet...</p>`;
            
            selectedPalletIds = []; 
            updateSelectedDisplay(); 

            if (!namaPalet || !sizePalet) {
                const existingStatusEl = document.getElementById('id-card-status');
                if (existingStatusEl) existingStatusEl.textContent = 'Pilih Nama Palet dan Size Palet terlebih dahulu.';
                return;
            }

            const filteredData = masterPalletData.filter(item => 
                String(item['Nama Palet']).trim() === namaPalet && String(item['Size']).trim() === sizePalet
            );
            
            const existingStatusEl = document.getElementById('id-card-status');
            if (existingStatusEl) existingStatusEl.remove();

            if (filteredData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full">Tidak ditemukan ID Palet yang sesuai untuk kriteria ini.</p>';
                return;
            }

            filteredData.forEach(item => {
                const idPalet = item['ID Palet'];
                if (!idPalet) return; 
                
                const card = document.createElement('div');
                card.id = `card-${idPalet}`;
                card.className = `id-card rounded-lg text-center shadow-md font-mono font-semibold hover:ring-2 hover:ring-green-500 transition`;
                card.textContent = idPalet;
                card.onclick = () => togglePalletSelection(idPalet);
                
                container.appendChild(card);
            });
        }
        
        function togglePalletSelection(idPalet) {
            const index = selectedPalletIds.indexOf(idPalet);
            const card = document.getElementById(`card-${idPalet}`);
            if (!card) return;

            if (index > -1) {
                selectedPalletIds.splice(index, 1);
                card.classList.remove('selected');
                showMessage('info', `ID Palet ${idPalet} dibatalkan.`);
            } else {
                selectedPalletIds.push(idPalet);
                card.classList.add('selected');
                showMessage('info', `ID Palet ${idPalet} ditambahkan. Total: ${selectedPalletIds.length}`);
            }
            
            updateSelectedDisplay();
        }
        
        function updateSelectedDisplay() {
            const displayEl = document.getElementById('selected-ids-display');
            const submitCountEl = document.getElementById('submit-count');
            const selectedCountEl = document.getElementById('selected-count');
            
            if (!submitCountEl || !selectedCountEl) return;
            
            submitCountEl.textContent = selectedPalletIds.length;
            selectedCountEl.textContent = `(${selectedPalletIds.length} Palet Dipilih)`;

            if (displayEl) {
                if (selectedPalletIds.length === 0) {
                    displayEl.innerHTML = '<span class="text-gray-400 text-sm">Belum ada palet yang dipilih.</span>';
                } else {
                    displayEl.innerHTML = selectedPalletIds.map(id => 
                        `<span class="selected-id-tag font-mono">${id}</span>`
                    ).join('');
                }
            }
        }
        
        // --- HELPER FUNCTIONS ---
        
        function createFormInput(label, id, type, required, placeholder, value = '', disabled = false) {
            const requiredAttr = required ? 'required' : '';
            const disabledAttr = disabled ? 'disabled' : '';
            const valueAttr = value ? `value="${value}"` : '';

            return `
                <label for="${id}" class="block text-sm font-medium text-gray-300 mb-1">
                    ${label} ${required ? '<span class="text-red-500">*</span>' : ''}
                </label>
                <input type="${type}" id="${id}" name="${id}" ${valueAttr} ${requiredAttr} ${disabledAttr}
                       class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:ring-green-500 focus:border-green-500 ${disabled ? 'opacity-50 cursor-not-allowed' : ''}"
                       placeholder="${placeholder}">
            `;
        }

        function createFormSelect(label, id, options, required, onChangeFunc = '') {
            const requiredAttr = required ? 'required' : '';
            const onChangeAttr = onChangeFunc ? `onchange="${onChangeFunc}()"` : '';
            
            return `
                <label for="${id}" class="block text-sm font-medium text-gray-300 mb-1">
                    ${label} ${required ? '<span class="text-red-500">*</span>' : ''}
                </label>
                <select id="${id}" name="${id}" ${requiredAttr} ${onChangeAttr}
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-green-500 focus:border-green-500">
                    ${createOptionHtml(options, `Pilih ${label}`)}
                </select>
            `;
        }
        
        function createOptionHtml(options, defaultLabel) {
             const optionHtml = options.map(opt => 
                `<option value="${opt.value}">${opt.label}</option>`
            ).join('');
            
            return `<option value="" disabled selected>${defaultLabel}</option>${optionHtml}`;
        }
        
        function showMessage(type, message) {
            const box = document.getElementById('transaction-message-box');
            if (!box) return;

            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-800', 'bg-green-800', 'bg-blue-800', 'text-white');

            if (type === 'success') {
                box.classList.add('bg-green-800', 'text-white');
            } else if (type === 'error') {
                box.classList.add('bg-red-800', 'text-white');
            } else if (type === 'loading' || type === 'info') {
                 box.classList.add('bg-blue-800', 'text-white');
            }
        }

        async function submitTransaction(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('submit-btn');
            const submitBtnTextEl = document.getElementById('submit-btn-text');
            const submitCountEl = document.getElementById('submit-count');
            
            if (!submitBtn || !submitBtnTextEl || !submitCountEl) {
                console.error("Elemen tombol submit tidak ditemukan.");
                return;
            }
            
            const formData = new FormData(form);
            
            if (selectedPalletIds.length === 0) {
                showMessage('error', 'âŒ Harap pilih minimal satu ID Palet dari kartu yang tersedia.');
                return;
            }

            submitBtn.disabled = true;
            submitBtnTextEl.textContent = 'Mengirim...';
            submitCountEl.textContent = selectedPalletIds.length; 
            
            showMessage('loading', `Mengirim data untuk ${selectedPalletIds.length} palet, mohon tunggu...`);

            const namaPalet = formData.get('namaPalet').trim();
            const sizePalet = formData.get('sizePalet').trim();
            const tanggalTransaksi = formData.get('tanggalTransaksi').trim();
            const jenisTransaksi = formData.get('jenisTransaksi').trim();
            const keterangan = formData.get('keterangan').trim() || '-';
            const idPaletString = selectedPalletIds.join(',');
            const now = new Date();
            const jamTransaksi = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const batchTransaction = {
                'Nama Palet': namaPalet,
                'Size': sizePalet, 
                'Tanggal Transaksi': tanggalTransaksi,
                'Jenis Transaksi': jenisTransaksi,
                'ID Palet': idPaletString, 
                'Jumlah Palet': selectedPalletIds.length,
                'Jam Transaksi': jamTransaksi,
                'Keterangan': keterangan,
                // (BARU) Menambahkan info user yang submit
                'Submitted By': currentUser ? currentUser.username : (userId || 'Unknown') 
            };

            const transactionsToSend = [batchTransaction];
            
            console.log(`Satu Transaksi Batch yang akan dikirim ke sheet ${TRANSACTION_SHEET_NAME}:`, batchTransaction);
            
            const payload = {
                sheetName: TRANSACTION_SHEET_NAME, 
                transactions: transactionsToSend, 
                submittedBy: currentUser ? currentUser.username : (userId || 'Unknown'), // Kirim user yang login
                timestamp: now.toLocaleString('id-ID'),
            };

            try {
                await fetch(MOCK_API_DEPLOY_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload), 
                });
                
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                showMessage('success', `âœ… Berhasil mencatat 1 Transaksi Batch (untuk ${selectedPalletIds.length} palet) ke ${TRANSACTION_SHEET_NAME}!`);
                form.reset();
                
                selectedPalletIds = [];
                updateSelectedDisplay(); 
                
                const sizePaletEl = document.getElementById('sizePalet');
                if (sizePaletEl) {
                    sizePaletEl.innerHTML = createOptionHtml([], 'Pilih Size Palet');
                    sizePaletEl.disabled = true;
                }
                const cardContainerEl = document.getElementById('pallet-id-card-container');
                if (cardContainerEl) {
                    cardContainerEl.innerHTML = '<p class="text-gray-500 col-span-full" id="id-card-status">Pilih Nama Palet dan Size Palet terlebih dahulu.</p>';
                }

            } catch (error) {
                console.error("Kesalahan saat mengirim data:", error);
                showMessage('error', `âŒ Gagal menyimpan transaksi batch. Pastikan Apps Script (sheet ${TRANSACTION_SHEET_NAME}) siap menerima data ini. Detail error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtnTextEl.textContent = 'Kirim Transaksi';
                if(selectedPalletIds.length === 0) {
                    submitCountEl.textContent = '0';
                }
            }
        }
        
        function createHeader(title, backPage) {
             return `
                <header class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3" id="header-${title.toLowerCase().replace(/\s/g, '-')}">
                    <div class="flex items-center">
                        <button onclick="navigate('${backPage}')" class="text-gray-400 hover:text-green-400 transition mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                        </button>
                        <h1 class="text-2xl font-bold text-green-400">${title}</h1>
                    </div>
                    <span id="${getStatusMessageId(title)}" class="text-sm text-gray-400">Siap mencatat</span>
                </header>
            `;
        }
        
        function createSummaryCard(value, title, colorClass) {
            return `
                <div class="bg-zinc-800 p-5 rounded-xl shadow-xl border-t-4 border-green-500">
                    <p class="text-sm text-gray-400 font-medium">${title}</p>
                    <p class="text-4xl font-extrabold mt-1 ${colorClass}">${value}</p>
                    <p class="text-xs text-gray-500 mt-2">Data diambil dari sheet "Ringkasan Stok Palet"</p>
                </div>
            `;
        }
        
        function createSummaryCardPlaceholder(value, title) {
            return `
                <div class="bg-zinc-800 p-5 rounded-xl shadow-xl border-t-4 border-gray-500">
                    <p class="text-sm text-gray-400 font-medium">${title}</p>
                    <p class="text-4xl font-extrabold mt-1 text-gray-500">${value}</p>
                    <p class="text-xs text-gray-600 mt-2">Menunggu data...</p>
                </div>
            `;
        }

        // --- 10. LOGIC UNTUK HISTORY PALET ---
        const HISTORY_PALET_TITLE = 'History Palet';

        function createHistoryPalletView() {
            return `
                <div id="history-pallet-view" class="app-view p-6">
                    ${createHeader(HISTORY_PALET_TITLE, 'dashboard')}
                    
                    <div class="mb-4">
                        <label for="history-filter" class="block text-sm font-medium text-gray-300 mb-1">Filter berdasarkan ID Palet:</label>
                        <input type="text" id="history-filter" onkeyup="filterHistoryTable()" 
                               class="w-full max-w-md px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:ring-green-500 focus:border-green-500" 
                               placeholder="Ketik ID Palet (contoh: P-001)...">
                    </div>

                    <h2 class="text-xl font-bold text-gray-300 mb-3 border-b border-gray-800 pb-2">Log Transaksi Palet (Batch)</h2>
                    <div id="table-container-history" class="shadow-lg rounded-xl overflow-x-auto">
                        <table id="pallet-table-history" class="pallet-table min-w-full divide-y divide-gray-700 rounded-xl">
                            <thead class="bg-gray-800"><tr></tr></thead>
                            <tbody class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>

                    <div id="error-box-history" class="hidden mt-4 p-4 rounded-lg bg-red-800 text-white font-semibold"></div>
                </div>
            `;
        }

        async function fetchHistoryPalletData() {
            const statusMessageEl = document.getElementById(getStatusMessageId(HISTORY_PALET_TITLE)); 
            const tableHeaderEl = document.querySelector('#pallet-table-history thead tr');
            const tableBodyEl = document.querySelector('#pallet-table-history tbody');
            const errorBoxEl = document.getElementById('error-box-history');
            
            if (!statusMessageEl || !tableHeaderEl || !tableBodyEl) return; 
            
            tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';

            await fetchGoogleSheetData(HISTORY_PALLET_URL, statusMessageEl, errorBoxEl, (parsedData, statusEl) => {
                const { data, headers } = parsedData;
                
                historyPalletData = data; 
                historyPalletHeaders = headers;
                
                if (data.length === 0) {
                    statusEl.textContent = "Data log transaksi tidak ditemukan.";
                    tableHeaderEl.innerHTML = '';
                    tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data Log Transaksi Palet yang tersedia.</td></tr>';
                    return;
                }

                statusEl.textContent = `${data.length} Log Transaksi Ditemukan`;

                tableHeaderEl.innerHTML = headers.map(header => 
                    `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-green-300">${header}</th>`
                ).join('');
                
                renderHistoryTableBody(data);
            });
        }
        
        function filterHistoryTable() {
            const filterInput = document.getElementById('history-filter');
            if (!filterInput) return;
            
            const filterValue = filterInput.value.toUpperCase().trim();
            
            if (!filterValue) {
                renderHistoryTableBody(historyPalletData);
                return;
            }
            
            const filteredData = historyPalletData.filter(item => {
                const idPaletString = String(item['ID Palet'] || '').toUpperCase();
                return idPaletString.includes(filterValue);
            });
            
            renderHistoryTableBody(filteredData);
        }
        
        function renderHistoryTableBody(data) {
            const tableBodyEl = document.querySelector('#pallet-table-history tbody');
            if (!tableBodyEl) return;
            
            if (data.length === 0) {
                const colSpan = historyPalletHeaders.length || 10;
                tableBodyEl.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4 text-gray-500">Data tidak ditemukan untuk filter ini.</td></tr>`;
                return;
            }

            tableBodyEl.innerHTML = data.map((item, index) => {
                const rowBgClass = (index % 2 === 0 ? 'bg-zinc-800' : 'bg-zinc-700');
                
                return `
                    <tr class="${rowBgClass} text-gray-200">
                        ${historyPalletHeaders.map(header => 
                            `<td class="px-6 py-3 whitespace-nowrap text-sm">${item[header] || '-'}</td>`
                        ).join('')}
                    </tr>
                `;
            }).join('');
        }


        // --- 11. TAMPILAN PLACEHOLDER MENU LAIN ---
        function createPlaceholderView(title, subtitle) {
            return `
                <div class="p-6 app-view">
                    ${createHeader(title, 'dashboard')}
                    <div class="bg-zinc-800 p-8 rounded-xl shadow-lg text-center mt-10">
                        <h2 class="text-xl font-semibold mb-2 text-gray-200">Fitur ${title}</h2>
                        <p class="text-gray-400 mb-4">${subtitle} - Halaman ini sedang dalam pengembangan.</p>
                        <p class="text-sm text-gray-500">Saat ini menu "Master Palet", "Stock Palet", "Transaksi Palet", dan "History Palet" sudah terintegrasi.</p>
                        <button onclick="navigate('dashboard')" class="mt-6 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition">
                            Kembali ke Menu Utama
                        </button>
                    </div>
                </div>
            `;
        }

        // --- 12. EKSEKUSI APLIKASI ---
        window.onload = () => {
            // Menjadikan fungsi global agar bisa dipanggil dari HTML
            window.navigate = navigate;
            window.submitTransaction = submitTransaction; 
            window.updateSizePallet = updateSizePallet;
            window.renderPalletIdCards = renderPalletIdCards;
            window.togglePalletSelection = togglePalletSelection; 
            window.filterHistoryTable = filterHistoryTable; 
            window.filterMasterPalletTable = filterMasterPalletTable;
            
            // (BARU) Daftarkan fungsi login/logout
            window.handleLogin = handleLogin;
            window.handleLogout = handleLogout;
            
            // (MODIFIKASI) Jalankan pemeriksaan sesi
            checkSessionAndRender();
        };

    </script>
</body>
</html>
