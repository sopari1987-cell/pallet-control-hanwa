<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROL PALET HANWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome untuk Icon -->
    <script src="https://kit.fontawesome.com/a1396a92f0.js" crossorigin="anonymous"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark Blue/Gray Background */
            color: #e2e8f0; /* Light text */
        }
        .header-bar {
            background-color: #2d3748; /* Header darker shade */
        }
        .card-dark {
            background-color: #2d3748;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-dark:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
        }
        .input-dark, .select-dark, .textarea-dark {
            background-color: #4a5568;
            border: 1px solid #718096;
            color: #e2e8f0;
        }
        .input-dark:focus, .select-dark:focus, .textarea-dark:focus {
            border-color: #63b3ed;
            box-shadow: 0 0 0 1px #63b3ed;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .table-dark thead {
            background-color: #2d3748;
        }
        .table-dark tbody tr:hover {
            background-color: #3b4554;
        }
    </style>
</head>
<body>

    <!-- URL Web App -->
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyDDp6x-07VQr3aSRqXNfWOmMEVofT-8M6NmUFhNrns0-XCeVd55SYrNC7b6qPgiLbj/exec'; 
        // Konstanta lainnya tetap sama
        const MASTER_SHEET_NAME = 'MASTER PALET';
        const TRANSACTION_SHEET_NAME = 'Log Transaksi Palet';
        let masterPaletsData = [];
    </script>

    <!-- Header / Nav Bar -->
    <header class="header-bar p-4 flex items-center justify-between sticky top-0 z-10">
        <div class="flex items-center">
            <i class="fas fa-boxes text-blue-400 text-xl mr-3"></i>
            <h1 class="text-xl font-bold text-gray-100">CONTROL PALET HANWA</h1>
        </div>
        <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-400 hidden sm:block">User ID: heSiluTqAL...</span>
            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-semibold">S</div>
        </div>
    </header>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-400"></div>
            <p class="text-gray-200 mt-3 text-lg">Memuat Data...</p>
        </div>
    </div>

    <main id="app-container" class="p-4 md:p-8">
        
        <!-- Dashboard View (Initial View) -->
        <div id="view-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            
            <!-- MASTER PALET Card -->
            <div onclick="switchView('master-list')" class="card-dark p-6 rounded-xl text-center cursor-pointer">
                <i class="fas fa-cube text-5xl text-blue-400 mb-3"></i>
                <h2 class="text-xl font-semibold mb-1">MASTER PALET</h2>
                <p class="text-sm text-gray-400">Data Induk Palet</p>
            </div>

            <!-- STOCK PALET Card -->
            <div onclick="switchView('stock-summary')" class="card-dark p-6 rounded-xl text-center cursor-pointer">
                <i class="fas fa-layer-group text-5xl text-blue-400 mb-3"></i>
                <h2 class="text-xl font-semibold mb-1">STOCK PALET</h2>
                <p class="text-sm text-gray-400">Ringkasan Stok Palet</p>
            </div>

            <!-- TRANSAKSI PALET Card -->
            <div onclick="switchView('transaction-list')" class="card-dark p-6 rounded-xl text-center cursor-pointer">
                <i class="fas fa-exchange-alt text-5xl text-blue-400 mb-3"></i>
                <h2 class="text-xl font-semibold mb-1">TRANSAKSI PALET</h2>
                <p class="text-sm text-gray-400">Log Pergerakan Palet</p>
            </div>

            <!-- STO PALET Card -->
            <div onclick="switchView('sto-input')" class="card-dark p-6 rounded-xl text-center cursor-pointer">
                <i class="fas fa-clipboard-check text-5xl text-blue-400 mb-3"></i>
                <h2 class="text-xl font-semibold mb-1">STO PALET</h2>
                <p class="text-sm text-gray-400">Stock Taking Palet</p>
            </div>
        </div>

        <!-- Master Palet List View -->
        <div id="view-master-list" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-100"><span onclick="switchView('dashboard')" class="cursor-pointer text-blue-400 hover:text-blue-300">HOME</span> / Master Palet</h2>
                <div class="flex space-x-3">
                    <button onclick="switchView('dashboard')" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-lg hover:bg-gray-700 transition duration-150">
                        <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                    </button>
                    <button onclick="showMasterModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150">
                        <i class="fas fa-plus mr-2"></i> Tambah Palet
                    </button>
                </div>
            </div>

            <!-- Master Palet Table -->
            <div class="card-dark p-6 rounded-xl">
                <h3 class="text-lg font-semibold mb-4 border-b border-gray-600 pb-2">Daftar Master Palet (<span id="master-palet-count">0</span>)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-600 table-dark">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID Palet</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tipe</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Lokasi</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Kapasitas (Kg)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Terakhir Diperbarui</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="master-palet-list" class="divide-y divide-gray-700">
                            <tr><td colspan="7" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Transaction List View (Sederhana untuk demo) -->
        <div id="view-transaction-list" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-100"><span onclick="switchView('dashboard')" class="cursor-pointer text-blue-400 hover:text-blue-300">HOME</span> / Log Transaksi Palet</h2>
                <div class="flex space-x-3">
                    <button onclick="switchView('dashboard')" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-lg hover:bg-gray-700 transition duration-150">
                        <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                    </button>
                    <button onclick="showTransactionModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150">
                        <i class="fas fa-truck-loading mr-2"></i> Catat Transaksi
                    </button>
                </div>
            </div>

            <!-- Transaction Log Table -->
            <div class="card-dark p-6 rounded-xl">
                <h3 class="text-lg font-semibold mb-4 border-b border-gray-600 pb-2">Riwayat Transaksi Palet (<span id="transaction-count">0</span>)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-600 table-dark">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Waktu</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID Palet</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tipe Transaksi</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Lokasi Baru</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Catatan</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-list" class="divide-y divide-gray-700">
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Placeholder views for Stock Summary and STO Input -->
        <div id="view-stock-summary" class="hidden text-center py-20 text-gray-400">
            <i class="fas fa-tools text-6xl mb-4"></i>
            <h2 class="text-2xl font-bold">Ringkasan Stok Palet</h2>
            <p>Fitur ini sedang dalam pengembangan.</p>
            <button onclick="switchView('dashboard')" class="mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150">
                Kembali ke Dashboard
            </button>
        </div>
        <div id="view-sto-input" class="hidden text-center py-20 text-gray-400">
            <i class="fas fa-clipboard-list text-6xl mb-4"></i>
            <h2 class="text-2xl font-bold">Input Stock Taking Palet (STO)</h2>
            <p>Fitur ini sedang dalam pengembangan.</p>
            <button onclick="switchView('dashboard')" class="mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150">
                Kembali ke Dashboard
            </button>
        </div>


    </main>

    <!-- Master Palet Modal (Tambah Palet Baru) -->
    <div id="master-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-40 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="card-dark w-11/12 max-w-lg rounded-xl p-6 transform translate-y-10 transition-transform duration-300">
            <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Tambah Master Palet Baru</h3>
            <form id="master-palet-form" onsubmit="window.handleMasterPaletSubmit(event)">
                <div class="mb-4">
                    <label for="masterPaletId" class="block text-sm font-medium mb-1 text-gray-300">Nama Palet (ID Palet)</label>
                    <input type="text" id="masterPaletId" name="masterPaletId" placeholder="PS01001 / HNW-A101" required class="w-full p-3 rounded-lg input-dark">
                </div>
                <div class="mb-4">
                    <label for="masterPaletSize" class="block text-sm font-medium mb-1 text-gray-300">Size (cth: 522.6 x 2395)</label>
                    <input type="text" id="masterPaletSize" name="masterPaletSize" placeholder="522.6 x 2395" required class="w-full p-3 rounded-lg input-dark">
                </div>
                <div class="mb-4">
                    <label for="masterPaletType" class="block text-sm font-medium mb-1 text-gray-300">Status</label>
                    <select id="masterPaletType" name="masterPaletType" required class="w-full p-3 rounded-lg select-dark">
                        <option value="Available">Available</option>
                        <option value="In Use">In Use</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="masterPaletLocation" class="block text-sm font-medium mb-1 text-gray-300">Lokasi</label>
                    <input type="text" id="masterPaletLocation" name="masterPaletLocation" placeholder="HANWA / Gudang A" required class="w-full p-3 rounded-lg input-dark">
                </div>
                <div class="mb-6">
                    <label for="masterPaletCapacity" class="block text-sm font-medium mb-1 text-gray-300">Keterangan</label>
                    <textarea id="masterPaletCapacity" name="masterPaletCapacity" rows="3" placeholder="Tambahkan keterangan tambahan (opsional)" class="w-full p-3 rounded-lg textarea-dark"></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal('master-modal')" class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-150">Batal</button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">Simpan Palet</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Transaction Modal (Catat Transaksi) -->
    <div id="transaction-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-40 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="card-dark w-11/12 max-w-lg rounded-xl p-6 transform translate-y-10 transition-transform duration-300">
            <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Catat Transaksi Palet</h3>
            <form id="transaction-form" onsubmit="window.handleTransactionSubmit(event)">
                <div class="mb-4">
                    <label for="transactionPaletId" class="block text-sm font-medium mb-1 text-gray-300">ID Palet</label>
                    <input type="text" id="transactionPaletId" name="transactionPaletId" placeholder="PS01001" required class="w-full p-3 rounded-lg input-dark">
                </div>
                <div class="mb-4">
                    <label for="transactionType" class="block text-sm font-medium mb-1 text-gray-300">Jenis Transaksi</label>
                    <select id="transactionType" name="transactionType" required class="w-full p-3 rounded-lg select-dark">
                        <option value="">Pilih Jenis Transaksi</option>
                        <option value="Incoming">Masuk Hanwa (Available)</option>
                        <option value="Outgoing">Keluar/Digunakan Produksi (In Use)</option>
                        <option value="Transfer">Transfer Lokasi (Available/In Use)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="transactionLocation" class="block text-sm font-medium mb-1 text-gray-300">Lokasi Baru</label>
                    <input type="text" id="transactionLocation" name="transactionLocation" placeholder="Line Produksi 1 / Gudang B" required class="w-full p-3 rounded-lg input-dark">
                </div>
                <div class="mb-6">
                    <label for="transactionNotes" class="block text-sm font-medium mb-1 text-gray-300">Keterangan</label>
                    <textarea id="transactionNotes" name="transactionNotes" rows="3" placeholder="Catatan Tambahan (Opsional)" class="w-full p-3 rounded-lg textarea-dark"></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal('transaction-modal')" class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-150">Batal</button>
                    <button type="submit" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150">Catat Transaksi</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Message/Error Modal -->
    <div id="message-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl p-6 w-11/12 max-w-sm card">
            <h3 id="modal-title" class="text-lg font-bold mb-3 text-gray-900">Pesan</h3>
            <p id="modal-body" class="text-gray-700 mb-4"></p>
            <button onclick="hideModal('message-modal')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150">Tutup</button>
        </div>
    </div>


    <script>
        // --- VIEW SWITCHER ---
        const switchView = (viewId) => {
            const views = ['view-dashboard', 'view-master-list', 'view-transaction-list', 'view-stock-summary', 'view-sto-input'];
            views.forEach(id => {
                const view = document.getElementById(id);
                if (view) {
                    if (id === `view-${viewId}` || id === viewId) {
                        view.classList.remove('hidden');
                    } else {
                        view.classList.add('hidden');
                    }
                }
            });
            // Reload data only when entering list views
            if (viewId === 'master-list' || viewId === 'transaction-list') {
                loadAllData();
            }
        };

        // --- MODAL UTILITIES ---
        const showModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100', 'pointer-events-auto');
            modal.querySelector('.card-dark').classList.remove('translate-y-10');
            modal.querySelector('.card-dark').classList.add('translate-y-0');
        }

        const hideModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.remove('opacity-100', 'pointer-events-auto');
            modal.classList.add('opacity-0', 'pointer-events-none');
            // Reset form if it exists
            const form = modal.querySelector('form');
            if(form) form.reset();
        }

        window.showMasterModal = () => showModal('master-modal');
        window.showTransactionModal = () => showModal('transaction-modal');
        
        window.showMessageModal = (message, type = 'info') => {
            const modal = document.getElementById('message-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            // Apply light theme style to message modal (for better visibility)
            modal.querySelector('.card').classList.remove('card-dark');
            modal.querySelector('.card').classList.add('bg-white');
            
            title.textContent = type === 'error' ? 'Gagal!' : (type === 'success' ? 'Berhasil!' : 'Pesan');
            body.textContent = message;

            title.className = `text-lg font-bold mb-3 ${type === 'error' ? 'text-red-600' : (type === 'success' ? 'text-green-600' : 'text-blue-600')}`;
            body.className = `text-gray-700 mb-4`;

            showModal('message-modal');
        };


        // --- FETCH UTILITY (Sama seperti sebelumnya, dengan backoff) ---
        const callWebApp = async (payload) => {
            if (WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE') {
                throw new Error("ERROR: URL Web App belum diset. Harap deploy Apps Script dan ganti URL Anda.");
            }
            
            const url = `${WEB_APP_URL}?type=${payload.action}`;
            
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(payload).toString()
            };

            const MAX_RETRIES = 5;
            let response = null;
            let lastError = null;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        break; 
                    } else if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000); 
                        await new Promise(resolve => setTimeout(resolve, delay));
                        lastError = new Error(`Request throttled (429). Retrying...`);
                    } else {
                        throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
                    }
                } catch (error) {
                    lastError = error;
                    if (i < MAX_RETRIES - 1) {
                         const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000);
                         await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            if (!response || !response.ok) {
                throw lastError || new Error("Gagal terhubung ke Apps Script setelah beberapa kali coba.");
            }
            
            const json = await response.json();
            
            if (json.status === 'error') {
                throw new Error(json.message);
            }
            return json;
        };


        // --- RENDERING FUNCTIONS ---
        const renderMasterPalets = (palets) => {
            const list = document.getElementById('master-palet-list');
            document.getElementById('master-palet-count').textContent = palets.length;
            list.innerHTML = ''; 

            if (palets.length === 0) {
                list.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Belum ada data Master Palet.</td></tr>';
                return;
            }

            palets.forEach(palet => {
                const row = document.createElement('tr');
                const statusClass = palet.Status === 'Available' ? 'bg-green-600' : (palet.Status === 'In Use' ? 'bg-red-600' : 'bg-yellow-600');
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-100">${palet.ID_Palet}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${palet.Size || palet.Tipe}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass} text-white">${palet.Status}</span></td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${palet.Lokasi}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${palet.Kapasitas || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${palet.Terakhir_Diperbarui}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                        <button onclick="window.handleDeleteMasterPalet('${palet.ID_Palet}')" class="text-red-400 hover:text-red-300 ml-2"><i class="fas fa-trash"></i> Hapus</button>
                    </td>
                `;
                list.appendChild(row);
            });
        };

        const renderTransactions = (transactions) => {
            const list = document.getElementById('transaction-list');
            document.getElementById('transaction-count').textContent = transactions.length;
            list.innerHTML = ''; 

            if (transactions.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada data Log Transaksi Palet.</td></tr>';
                return;
            }

            // Sort: Newest first
            transactions.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            transactions.forEach(tx => {
                const row = document.createElement('tr');
                let typeColor = 'text-gray-300';
                if (tx.Tipe_Transaksi.toLowerCase().includes('masuk')) typeColor = 'text-green-400';
                else if (tx.Tipe_Transaksi.toLowerCase().includes('keluar') || tx.Tipe_Transaksi.toLowerCase().includes('produksi')) typeColor = 'text-red-400';
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-400">${tx.Timestamp}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-100">${tx.ID_Palet}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${typeColor}">${tx.Tipe_Transaksi}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${tx.Lokasi_Baru}</td>
                    <td class="px-4 py-3 text-sm text-gray-400 max-w-xs truncate" title="${tx.Catatan || ''}">${tx.Catatan || '-'}</td>
                `;
                list.appendChild(row);
            });
        };


        // --- MASTER PALET HANDLERS ---
        window.handleMasterPaletSubmit = async (event) => {
            event.preventDefault();
            hideModal('master-modal');
            LOADING_OVERLAY.classList.remove('hidden');

            const form = event.target;
            const formData = new FormData(form);

            const paletId = formData.get('masterPaletId').toUpperCase().trim();
            
            const paletData = {
                ID_Palet: paletId,
                Size: formData.get('masterPaletSize'), // Menggunakan "Size"
                Lokasi: formData.get('masterPaletLocation'),
                Kapasitas: formData.get('masterPaletCapacity'), // Menggunakan Kapasitas untuk Keterangan
                Status: formData.get('masterPaletType'), // Menggunakan Type untuk Status
                Terakhir_Diperbarui: new Date().toLocaleString('id-ID'),
            };

            const payload = {
                action: 'addMaster',
                data: JSON.stringify(paletData)
            };

            try {
                const result = await callWebApp(payload);
                showMessageModal(result.message, 'success');
                form.reset();
                if (document.getElementById('view-master-list').classList.contains('hidden') === false) {
                    await loadAllData(); 
                }
            } catch (error) {
                console.error("Gagal menyimpan Palet:", error);
                showMessageModal(`Gagal menyimpan Palet: ${error.message}. Cek konsol untuk detail.`, 'error');
            } finally {
                LOADING_OVERLAY.classList.add('hidden');
            }
        };

        window.handleDeleteMasterPalet = async (paletId) => {
            const confirmed = window.confirm(`Yakin ingin menghapus Master Palet ID: ${paletId}? Tindakan ini tidak dapat dibatalkan.`);
            if (!confirmed) {
                return;
            }

            LOADING_OVERLAY.classList.remove('hidden');

            const payload = {
                action: 'deleteMaster',
                ID_Palet: paletId
            };

            try {
                const result = await callWebApp(payload);
                showMessageModal(result.message, 'success');
                await loadAllData();
            } catch (error) {
                console.error("Gagal menghapus Palet:", error);
                showMessageModal(`Gagal menghapus Palet: ${error.message}. Cek konsol untuk detail.`, 'error');
            } finally {
                LOADING_OVERLAY.classList.add('hidden');
            }
        };

        // --- TRANSACTION HANDLERS ---
        window.handleTransactionSubmit = async (event) => {
            event.preventDefault();
            hideModal('transaction-modal');
            LOADING_OVERLAY.classList.remove('hidden');

            const form = event.target;
            const formData = new FormData(form);

            const paletId = formData.get('transactionPaletId').toUpperCase().trim();
            const transactionType = formData.get('transactionType');
            const newLocation = formData.get('transactionLocation');
            const notes = formData.get('transactionNotes');

            try {
                // 1. Check Palet Existence (Master Palet data must be loaded)
                if(masterPaletsData.length === 0) await loadAllData(false); // Pastikan data master dimuat
                const existingPalet = masterPaletsData.find(p => p.ID_Palet === paletId);
                if (!existingPalet) {
                    throw new Error(`Master Palet ID ${paletId} tidak ditemukan. Harap daftarkan palet ini terlebih dahulu.`);
                }
                
                // 2. Determine New Status based on transaction type
                let newStatus = existingPalet.Status;
                if (transactionType === 'Incoming') newStatus = 'Available';
                else if (transactionType === 'Outgoing') newStatus = 'In Use';
                else if (transactionType === 'Transfer') newStatus = existingPalet.Status; // Status tidak berubah saat transfer

                // 3. Prepare Update Data
                const masterUpdateData = {
                    ID_Palet: paletId,
                    Lokasi: newLocation,
                    Status: newStatus,
                    Terakhir_Diperbarui: new Date().toLocaleString('id-ID'),
                };
                
                const transactionData = {
                    ID_Palet: paletId,
                    Tipe_Transaksi: transactionType,
                    Lokasi_Baru: newLocation,
                    Catatan: notes,
                    Timestamp: new Date().toLocaleString('id-ID'),
                };

                // 4. Send combined action to Web App
                const payload = {
                    action: 'recordTransaction',
                    masterUpdate: JSON.stringify(masterUpdateData),
                    newTransaction: JSON.stringify(transactionData)
                };

                const result = await callWebApp(payload);

                showMessageModal(`Transaksi Palet ${paletId} (${transactionType}) berhasil dicatat.`, 'success');
                form.reset();
                if (document.getElementById('view-transaction-list').classList.contains('hidden') === false) {
                    await loadAllData(); 
                }
                
            } catch (error) {
                console.error("Gagal mencatat transaksi. Detail Error:", error);
                showMessageModal(`Gagal mencatat transaksi: ${error.message}. Cek konsol untuk detail.`, 'error');
            } finally {
                LOADING_OVERLAY.classList.add('hidden');
            }
        };


        // --- DATA INITIALIZATION ---
        const loadAllData = async (showLoading = true) => {
            if(showLoading) LOADING_OVERLAY.classList.remove('hidden');
            
            try {
                // 1. Fetch Master Palets
                const masterResult = await callWebApp({ action: 'getAllData', sheetName: MASTER_SHEET_NAME });
                masterPaletsData = masterResult.data; 
                if (document.getElementById('view-master-list').classList.contains('hidden') === false) {
                    renderMasterPalets(masterPaletsData);
                }

                // 2. Fetch Transactions
                const transactionResult = await callWebApp({ action: 'getAllData', sheetName: TRANSACTION_SHEET_NAME });
                if (document.getElementById('view-transaction-list').classList.contains('hidden') === false) {
                    renderTransactions(transactionResult.data); 
                }

            } catch (error) {
                console.error("Gagal memuat data:", error);
                // Hanya tampilkan modal error jika ini adalah load pertama atau load list view
                if(showLoading) {
                    showMessageModal(`Gagal memuat data. Pastikan Apps Script sudah di-deploy dan URL sudah benar. Detail Error: ${error.message}`, 'error');
                }
            } finally {
                if(showLoading) LOADING_OVERLAY.classList.add('hidden');
            }
        }


        // --- INITIALIZATION ---
        window.onload = () => {
            switchView('dashboard');
            // Muat data di background saat pertama kali load
            loadAllData(false); 
        };
    </script>
</body>
</html>
