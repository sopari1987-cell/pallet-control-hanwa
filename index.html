<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrol Palet Hanwa</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font default dan dark mode (Tema Hijau/Hitam/Putih) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #18181b; /* Warna background gelap (mendekati hitam - Zinc 900) */
            color: #ffffff; /* Warna teks terang (Putih) */
        }
        /* Style untuk kartu menu */
        .menu-card {
            background-color: #27272a; /* Zinc 800 */
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .menu-card:hover {
            background-color: #3f3f46; /* Zinc 700 */
            transform: translateY(-3px);
            border-color: #22c55e; /* Border hijau (Green 500) saat hover */
        }
        .icon {
            color: #9ca3af; /* Warna ikon default (abu-abu terang) */
            transition: color 0.3s ease-in-out;
        }
        .menu-card:hover .icon {
            color: #22c55e; /* Warna ikon hijau (Green 500) saat hover */
        }
        /* Style untuk App View */
        .app-view {
            background-color: #18181b; /* Zinc 900 */
            color: #ffffff; /* Putih */
            min-height: 100vh;
        }
        /* Style untuk Tabel */
        .pallet-table {
            background-color: #27272a; /* Zinc 800 */
        }
        .pallet-table th {
            /* Styling header yang ditingkatkan */
            background-color: #18181b; /* Zinc 900 (Lebih gelap) */
            color: #9ca3af;
            border-bottom: 2px solid #22c55e; /* Garis bawah hijau (Green 500) */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .pallet-table tr:nth-child(even) {
            background-color: #3f3f46; /* Zinc 700 */
        }
        /* Kelas warna bersyarat (Tetap sama) */
        .color-green { color: #34d399; } /* Tailwind green-400 */
        .color-orange { color: #f97316; } /* Tailwind orange-600 */
        .color-red { color: #f87171; } /* Tailwind red-400 */
        /* Style untuk tombol */
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); /* Bayangan hijau */
        }
        /* Style untuk ID Palet Card */
        .id-card {
            background-color: #18181b; /* Zinc 900 */
            border: 1px solid #22c55e; /* Border hijau (Green 500) */
            transition: all 0.2s;
            cursor: pointer;
            /* Lebih ringkas */
            padding: 0.5rem 0.75rem; 
            font-size: 0.875rem; /* text-sm */
        }
        .id-card.selected {
            background-color: #22c55e; /* Warna hijau (Green 500) jika terpilih */
            color: #18181b; /* Teks gelap agar kontras di atas hijau */
            border-color: #16a34a; /* Green 600 */
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
        }
        /* Style untuk display ID yang dipilih */
        .selected-id-tag {
            background-color: #22c55e; /* Green 500 */
            color: #18181b; /* Teks gelap */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container" class="min-h-screen">
        <!-- Konten akan dimuat di sini oleh JavaScript -->
    </div>

    <!-- Firebase, Navigasi, dan Logic JavaScript -->
    <script type="module">
        // --- 1. SETUP FIREBASE (MANDATORI SESUAI ATURAN PLATFORM) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        
        // --- DATA STATE GLOBAL BARU ---
        let masterPalletData = []; // Menyimpan semua data Master Palet
        let selectedPalletIds = []; // Menyimpan ID Palet yang sedang dipilih untuk transaksi

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Render ulang setelah auth
                        renderApp(localStorage.getItem('currentPage') || 'dashboard');
                    } else {
                        // Fallback jika auth gagal, gunakan ID acak
                        userId = 'guest-' + crypto.randomUUID().substring(0, 8);
                        renderApp(localStorage.getItem('currentPage') || 'dashboard');
                    }
                    console.log("Firebase Auth State Changed. User ID:", userId);
                });
            } catch (error) {
                console.error("Kesalahan saat inisialisasi Firebase:", error);
                // Render tetap berjalan meskipun ada error Firebase
                renderApp(localStorage.getItem('currentPage') || 'dashboard');
            }
        }
        
        // --- 2. NAVIGASI STATE ---
        function navigate(page) {
            localStorage.setItem('currentPage', page);
            // Bersihkan state ID Palet saat pindah halaman
            if (page !== 'transaksiPalet') {
                selectedPalletIds = [];
            }
            renderApp(page);
        }

        // --- 3. RENDERING UTAMA ---
        function renderApp(page) {
            const container = document.getElementById('app-container');
            container.innerHTML = ''; // Bersihkan konten

            switch (page) {
                case 'masterPalet':
                    container.innerHTML = createMasterPalletView();
                    fetchMasterPalletData(); // Panggil fungsi fetch data
                    break;
                case 'stockPalet':
                    container.innerHTML = createStockPalletView(); // Panggil view baru
                    fetchStockPalletData(); // Panggil fungsi fetch data baru
                    break;
                case 'transaksiPalet':
                    // Pastikan state multi-select direset saat masuk view
                    selectedPalletIds = []; 
                    container.innerHTML = createTransactionPalletView();
                    fetchMasterDataForTransaction(); // Panggil fungsi fetch data Master baru
                    break;
                case 'stoPalet':
                    container.innerHTML = createPlaceholderView('STO Palet', 'Stock Taking Palet');
                    break;
                case 'dashboard':
                default:
                    container.innerHTML = createDashboardView();
                    break;
            }
        }
        
        // --- HELPER: Mendapatkan ID pesan status berdasarkan judul ---
        function getStatusMessageId(title) {
            return `status-message-${title.toLowerCase().replace(/\s/g, '-')}`;
        }


        // --- 4. TAMPILAN DASHBOARD (Menu Utama) ---
        function createDashboardView() {
            return `
                <div class="p-6">
                    <header class="flex justify-between items-center mb-10">
                        <div class="flex items-center">
                            <!-- Icon Palet (SVG sederhana) - Diubah ke Hijau -->
                            <svg class="w-8 h-8 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10M10 7v10M16 7v10M20 4v16a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h12a2 2 0 012 2z"></path>
                            </svg>
                            <h1 class="text-3xl font-bold text-gray-100 uppercase">Control Palet Hanwa</h1>
                        </div>
                        <div class="flex items-center text-sm text-gray-400">
                            <span class="mr-3 hidden sm:inline">User ID: ${userId || 'Memuat...'}</span>
                            <!-- Icon User -->
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.939 13.939 0 0112 16c2.585 0 5.043.682 7.079 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    </header>

                    <!-- Grid Menu Utama (4x4, responsif) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">
                        
                        <!-- MASTER PALET -->
                        <div onclick="navigate('masterPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <!-- Icon Kubus (Master) -->
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10m-4-11l-4 2.12V17M16 12l4 2.12V17"></path>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Master Palet</h2>
                                <p class="text-sm text-gray-400">Data Induk Palet</p>
                            </div>
                        </div>

                        <!-- STOCK PALET -->
                        <div onclick="navigate('stockPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <!-- Icon Stack (Stok) -->
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 12V3h16v9m-4-4l-4 4-4-4m8 8h-8v4h8v-4z"></path>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Stock Palet</h2>
                                <p class="text-sm text-gray-400">Ringkasan Stok Palet</p>
                            </div>
                        </div>

                        <!-- TRANSAKSI PALET -->
                        <div onclick="navigate('transaksiPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <!-- Icon Log/Kunci (Transaksi/Pergerakan) -->
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14m-1.447 3.382l-.675.337M4 12a7 7 0 1014 0 7 7 0 01-14 0z"></path>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Transaksi Palet</h2>
                                <p class="text-sm text-gray-400">Log Pergerakan Palet</p>
                            </div>
                        </div>

                        <!-- STO PALET -->
                        <div onclick="navigate('stoPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <!-- Icon Checklist (STO/Stock Taking) -->
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold uppercase mb-1 text-gray-100">STO Palet</h2>
                                <p class="text-sm text-gray-400">Stock Taking Palet</p>
                            </div>
                        </div>

                    </div>
                    
                    <footer class="mt-12 text-center text-xs text-white-600">
                        Aplikasi Kontrol Palet (v2.0 ) - Elaborated by SOPARI-HSSI0293
                    </footer>
                </div>
            `;
        }
        
        // --- 5. SETUP GOOGLE SHEET URLS ---
        
        // GANTI NILAI DI BAWAH INI DENGAN DATA SHEET ANDA YANG SEBENARNYA
        const GOOGLE_SHEET_ID = '1YiIDIa0Ysi-O0k4askOtd8Qf66KnQuJxlLMngDlqM1A'; // GANTI dengan ID Google Sheet Anda
        const MASTER_SHEET_NAME = 'MASTER PALET'; 
        const STOCK_SHEET_NAME = 'Ringkasan Stok Palet'; 
        // --- PERUBAHAN NAMA SHEET TRANSAKSI SESUAI PERMINTAAN USER ---
        const TRANSACTION_SHEET_NAME = 'Log Transaksi Palet Batch'; 
        const RANGE = 'A:H'; 

        const MASTER_PALLET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${MASTER_SHEET_NAME}&range=${RANGE}`;
        const STOCK_PALLET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${STOCK_SHEET_NAME}&range=${RANGE}`;
        
        // --- PENTING: CONFIGURASI BACKEND UNTUK SUBMIT DATA ---
        // GANTI URL DI BAWAH INI DENGAN URL DEPLOYMENT APPS SCRIPT ANDA
        // Apps Script harus disiapkan untuk menerima array transaksi dan menyimpannya ke sheet "Log Transaksi Palet Batch"
        const MOCK_API_DEPLOY_URL = 'https://script.google.com/macros/s/AKfycbwiq9RP1jZykmw8a4W1PNgoUgfekOxCkAiHhnLtzFX8YB1I8TTPnzgkhNYQZH6I-MZJ/exec'; 

        // --- 6. FUNGSI FETCH DATA UNIVERSAL (Read Only) ---
        
        /**
         * Mengambil data dari Google Sheet.
         * @param {string} url - URL GViz Google Sheet.
         * @param {HTMLElement} statusEl - Elemen untuk menampilkan status loading/sukses.
         * @param {HTMLElement} errorBoxEl - Elemen untuk menampilkan pesan error.
         * @param {function} successCallback - Callback yang dipanggil saat data berhasil diurai.
         */
        async function fetchGoogleSheetData(url, statusEl, errorBoxEl, successCallback) {
            statusEl.textContent = 'Memuat data...';
            errorBoxEl.classList.add('hidden');

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Status ${response.status}`);
                
                const text = await response.text();
                // Membersihkan respon dari Google GViz
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);
                
                if (data.status !== 'ok') {
                    throw new Error(`Query error: ${data.errors ? data.errors[0].message : 'Unknown error'}`);
                }

                const parsedData = parseGVizData(data);
                successCallback(parsedData, statusEl);
                
            } catch (error) {
                console.error("Kesalahan saat mengambil data Google Sheet:", error);
                statusEl.textContent = 'Gagal memuat data.';
                errorBoxEl.textContent = `üö® GAGAL MEMUAT DATA: ${error.message}. Pastikan ID Sheet, Nama Sheet, dan Izin akses publik sudah benar.`;
                errorBoxEl.classList.remove('hidden');
            }
        }
        
        /**
         * Mengurai struktur data GViz menjadi array objek JavaScript yang sederhana.
         */
        function parseGVizData(data) {
            const columns = data.table.cols.map(col => ({
                id: col.id,
                label: col.label || col.id  
            })).filter(col => col.label); // Hilangkan kolom tanpa label

            const rows = data.table.rows;
            const result = [];

            // Pastikan baris data tidak kosong (header saja)
            if (rows.length > 0) {
                for (const row of rows) {
                    const rowObject = {};
                    for (let i = 0; i < columns.length; i++) {
                        const colLabel = columns[i].label;
                        // Ambil nilai yang diformat (f) jika ada, jika tidak, ambil nilai mentah (v)
                        rowObject[colLabel] = row.c[i] ? (row.c[i].f || row.c[i].v) : '';
                    }
                    result.push(rowObject);
                }
            }
            
            return { data: result, headers: columns.map(c => c.label) };
        }

        // --- 7. LOGIC UNTUK MASTER PALET (Tabel Detail) ---
        const MASTER_PALET_TITLE = 'Master Palet';

        function createMasterPalletView() {
            return `
                <div id="master-pallet-view" class="app-view p-6">
                    ${createHeader(MASTER_PALET_TITLE, 'dashboard')}

                    <h2 class="text-xl font-bold text-gray-300 mb-3 border-b border-gray-800 pb-2">Detail Data Palet</h2>
                    <div id="table-container" class="shadow-lg rounded-xl overflow-x-auto">
                        <table id="pallet-table-master" class="pallet-table min-w-full divide-y divide-gray-700 rounded-xl">
                            <thead class="bg-gray-800"><tr></tr></thead>
                            <tbody class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>

                    <div id="error-box-master" class="hidden mt-4 p-4 rounded-lg bg-red-800 text-white font-semibold"></div>
                </div>
            `;
        }

        async function fetchMasterPalletData() {
            const statusMessageEl = document.getElementById(getStatusMessageId(MASTER_PALET_TITLE)); 
            const tableHeaderEl = document.querySelector('#pallet-table-master thead tr');
            const tableBodyEl = document.querySelector('#pallet-table-master tbody');
            const errorBoxEl = document.getElementById('error-box-master');
            
            if (!statusMessageEl) return; 
            
            tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';


            await fetchGoogleSheetData(MASTER_PALLET_URL, statusMessageEl, errorBoxEl, (parsedData, statusEl) => {
                const { data, headers } = parsedData;
                masterPalletData = data; 
                
                if (data.length === 0) {
                    statusEl.textContent = "Data tidak ditemukan.";
                    tableHeaderEl.innerHTML = '';
                    tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data Master Palet yang tersedia.</td></tr>';
                    return;
                }

                statusEl.textContent = `${data.length} Data Palet Ditemukan`;

                // Diubah ke text-green-300
                tableHeaderEl.innerHTML = headers.map(header => 
                    `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-green-300">${header}</th>`
                ).join('');

                tableBodyEl.innerHTML = data.map((item, index) => {
                    const status = item['Status'] || '';
                    const lokasi = item['Lokasi'] || '';

                    const rowColorClass = getRowColorClass(status, lokasi);
                    // Diubah ke bg-zinc-800 / bg-zinc-700
                    const rowBgClass = (index % 2 === 0 ? 'bg-zinc-800' : 'bg-zinc-700');
                    
                    return `
                        <tr class="${rowBgClass} ${rowColorClass}">
                            ${headers.map(header => 
                                `<td class="px-6 py-3 whitespace-nowrap text-sm">${item[header] || '-'}</td>`
                            ).join('')}
                        </tr>
                    `;
                }).join('');
            });
        }
        
        function getRowColorClass(status, lokasi) {
            const s = String(status).toUpperCase().trim();
            const l = String(lokasi).toUpperCase().trim();

            if (s === 'KOSONG' && l === 'AREA PALET') {
                return 'color-green'; 
            }
            if (s === 'TERISI' && (l === 'AREA PRODUCT' || l === 'GUDANG')) {
                return 'color-orange'; 
            }
            if (s === 'TERISI' && l === 'CUSTOMER') {
                return 'color-red'; 
            }
            return 'text-gray-200'; 
        }
        
        // --- 8. LOGIC UNTUK STOCK PALET (Ringkasan/Total) ---
        const STOCK_PALET_TITLE = 'Stock Palet';

        function createStockPalletView() {
            return `
                <div id="stock-pallet-view" class="app-view p-6">
                    ${createHeader(STOCK_PALET_TITLE, 'dashboard')}

                    <h2 class="text-xl font-bold text-gray-300 mb-4 border-b border-gray-800 pb-2">Ringkasan Stok Palet Berdasarkan Lokasi</h2>
                    
                    <!-- Kontainer Kartu Ringkasan -->
                    <div id="stock-summary-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <!-- Kartu akan diisi di sini -->
                    </div>

                    <h2 class="text-xl font-bold text-gray-300 mb-3 border-b border-gray-800 pb-2">Detail Data Ringkasan</h2>
                    <div id="table-container-stock" class="shadow-lg rounded-xl overflow-x-auto">
                        <table id="pallet-table-stock" class="pallet-table min-w-full divide-y divide-gray-700 rounded-xl">
                            <thead class="bg-gray-800"><tr></tr></thead>
                            <tbody class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>

                    <div id="error-box-stock" class="hidden mt-4 p-4 rounded-lg bg-red-800 text-white font-semibold"></div>
                </div>
            `;
        }

        async function fetchStockPalletData() {
            const statusMessageEl = document.getElementById(getStatusMessageId(STOCK_PALET_TITLE));
            const summaryContainerEl = document.getElementById('stock-summary-container');
            const tableHeaderEl = document.querySelector('#pallet-table-stock thead tr');
            const tableBodyEl = document.querySelector('#pallet-table-stock tbody');
            const errorBoxEl = document.getElementById('error-box-stock');
            
            if (!statusMessageEl) return; 

            summaryContainerEl.innerHTML = createSummaryCardPlaceholder('Memuat...', 'Total Palet Hanwa');
            tableHeaderEl.innerHTML = '';
            tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';

            
            await fetchGoogleSheetData(STOCK_PALLET_URL, statusMessageEl, errorBoxEl, (parsedData, statusEl) => {
                const { data, headers } = parsedData;
                
                if (data.length === 0) {
                    statusEl.textContent = "Data ringkasan stok tidak ditemukan.";
                    tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data Ringkasan Stok Palet yang tersedia.</td></tr>';
                    summaryContainerEl.innerHTML = createSummaryCardPlaceholder(0, 'Total Palet Hanwa');
                    return;
                }

                statusEl.textContent = `${data.length} Baris Ringkasan Ditemukan`;

                const totalIndex = headers.length > 0 ? headers.findIndex(h => h.toUpperCase().includes('TOTAL')) : -1;
                let grandTotal = 0;
                
                data.forEach(item => {
                    const totalValue = totalIndex >= 0 ? parseFloat(String(Object.values(item)[totalIndex]).replace(/[^0-9.,]/g, '').replace(',', '.') || 0) : 0;
                    grandTotal += totalValue;
                });

                // Diubah ke text-green-400
                summaryContainerEl.innerHTML = createSummaryCard(grandTotal.toLocaleString('id-ID'), 'Total Palet Hanwa', 'text-green-400');

                // Diubah ke text-green-300
                tableHeaderEl.innerHTML = headers.map(header => 
                    `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-green-300">${header}</th>`
                ).join('');

                tableBodyEl.innerHTML = data.map((item, index) => {
                    // Diubah ke bg-zinc-800 / bg-zinc-700
                    const rowBgClass = (index % 2 === 0 ? 'bg-zinc-800' : 'bg-zinc-700');
                    return `
                        <tr class="${rowBgClass} text-gray-200">
                            ${headers.map(header => 
                                `<td class="px-6 py-3 whitespace-nowrap text-sm">${item[header] || '-'}</td>`
                            ).join('')}
                        </tr>
                    `;
                }).join('');
            });
        }

        // --- 9. LOGIC UNTUK TRANSAKSI PALET (Form Input) ---
        const TRANSACTION_PALET_TITLE = 'Transaksi Palet';

        function createTransactionPalletView() {
            // Mendapatkan tanggal hari ini dalam format YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            
            return `
                <div id="transaction-pallet-view" class="app-view p-6 max-w-4xl mx-auto">
                    ${createHeader(TRANSACTION_PALET_TITLE, 'dashboard')}

                    <div class="bg-zinc-800 p-6 sm:p-8 rounded-xl shadow-2xl">
                        <p class="text-sm text-gray-400 mb-6">
                            Gunakan formulir ini untuk mencatat pergerakan <span class="font-bold text-green-300">beberapa</span> palet sekaligus.
                        </p>

                        <!-- Kotak Pesan Status -->
                        <div id="transaction-message-box" class="hidden p-3 rounded-lg text-sm mb-4 font-medium" role="alert"></div>

                        <form id="transaction-form" onsubmit="submitTransaction(event)">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                
                                <!-- NAMA PALET -->
                                <div>
                                    ${createFormSelect('Nama Palet', 'namaPalet', [], true, 'updateSizePallet')}
                                </div>
                                
                                <!-- SIZE PALET -->
                                <div>
                                    ${createFormSelect('Size Palet', 'sizePalet', [], true, 'renderPalletIdCards')}
                                </div>

                                <!-- Tanggal Transaksi -->
                                <div>
                                    ${createFormInput('Tanggal Transaksi', 'tanggalTransaksi', 'date', true, '', today)}
                                </div>
                                
                                <!-- Jenis Transaksi (Opsi baru dan Lokasi/Status akan diderivasi dari sini) -->
                                <div>
                                    ${createFormSelect('Jenis Transaksi', 'jenisTransaksi', [
                                        { value: 'DIGUNAKAN PRODUKSI', label: 'di Gunakan Produksi' },
                                        { value: 'KELUAR HANWA', label: 'Keluar Hanwa (Pengiriman)' },
                                        { value: 'MASUK HANWA', label: 'Masuk Hanwa (Penerimaan)' }
                                    ], true)}
                                </div>
                                
                                <!-- Lokasi Awal dan Status Akhir Dihapus karena sudah otomatis -->

                                <!-- Keterangan (Textarea) -->
                                <div class="md:col-span-2">
                                    <label for="keterangan" class="block text-sm font-medium text-gray-300 mb-1">Keterangan (Opsional)</label>
                                    <textarea id="keterangan" name="keterangan" rows="3" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-green-500 focus:border-green-500"></textarea>
                                </div>
                            </div>

                            <!-- Kontainer Kartu ID Palet -->
                            <div class="mt-8">
                                <h3 class="text-lg font-bold text-gray-300 mb-3 border-b border-gray-700 pb-1">1. Pilih ID Palet Tersedia <span id="selected-count" class="text-green-400 text-sm font-normal">(0 Palet Dipilih)</span></h3>
                                <div id="pallet-id-card-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3">
                                    <p class="text-gray-500 col-span-full" id="id-card-status">Pilih Nama Palet dan Size Palet terlebih dahulu.</p>
                                </div>
                            </div>
                            
                            <!-- Display ID Palet yang dipilih -->
                            <div class="mt-6 p-4 bg-gray-700 rounded-lg border border-green-500">
                                <h4 class="text-sm font-semibold text-green-300 mb-2">2. ID Palet yang akan Diproses:</h4>
                                <div id="selected-ids-display" class="flex flex-wrap gap-2 min-h-[2.5rem]">
                                    <span class="text-gray-400 text-sm">Belum ada palet yang dipilih.</span>
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-4 border-t border-gray-700 flex justify-end">
                                <button type="submit" id="submit-btn" class="btn-primary bg-green-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-700 transition">
                                    <!-- PERBAIKAN ERROR: Membungkus teks dalam <span> baru -->
                                    <span id="submit-btn-text">Kirim Transaksi</span> (<span id="submit-count">0</span> Palet)
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        // --- LOGIC BARU/MODIFIKASI UNTUK MULTI-SELECT ---

        /**
         * Mengambil data Master Palet dan mengisi dropdown Nama Palet.
         */
        async function fetchMasterDataForTransaction() {
            const statusMessageEl = document.getElementById(getStatusMessageId(TRANSACTION_PALET_TITLE)); 
            const namaPaletEl = document.getElementById('namaPalet');
            
            namaPaletEl.innerHTML = '<option value="" disabled selected>Memuat data...</option>';
            namaPaletEl.disabled = true;

            const updateMasterData = (parsedData, statusEl) => {
                const { data } = parsedData;
                masterPalletData = data; 
                
                if (data.length === 0) {
                    statusEl.textContent = "Data Master Palet kosong. Transaksi dibatalkan.";
                    return;
                }

                // Ambil Nama Palet unik dan pastikan nilainya tidak kosong
                const uniqueNames = [...new Set(data.map(item => String(item['Nama Palet']).trim()).filter(name => name))];
                const options = uniqueNames.map(name => ({ value: name, label: name }));
                namaPaletEl.innerHTML = createOptionHtml(options, 'Pilih Nama Palet');
                namaPaletEl.disabled = false;
                statusEl.textContent = `Data Master siap (${data.length} entri)`;
                
                // updateSizePallet(); // Tidak perlu dipanggil di sini, akan dipanggil oleh event 'change' pertama
            };

            await fetchGoogleSheetData(MASTER_PALLET_URL, statusMessageEl, {classList:{add:()=>{}, remove:()=>{}}}, updateMasterData);
        }
        
        /**
         * Dipanggil saat Nama Palet diubah. Mengisi dropdown Size Palet.
         * Telah diperbaiki: menggunakan .trim() untuk robust filtering.
         */
        function updateSizePallet() {
            // PERBAIKAN: Gunakan .trim() untuk menghilangkan spasi yang tidak disengaja dari data sheet
            const namaPalet = document.getElementById('namaPalet').value.trim();
            const sizePaletEl = document.getElementById('sizePalet');
            
            // Reset elemen size
            sizePaletEl.innerHTML = createOptionHtml([], 'Pilih Size Palet');
            sizePaletEl.disabled = true;
            
            // Reset state dan tampilan
            selectedPalletIds = []; 
            updateSelectedDisplay();
            renderPalletIdCards(); // Panggil ulang untuk menampilkan pesan "Pilih Size"

            if (!namaPalet) return;

            // PERBAIKAN: Gunakan .trim() pada data master saat filtering
            const filteredBySize = masterPalletData.filter(item => 
                String(item['Nama Palet']).trim() === namaPalet
            );
            
            const uniqueSizes = [...new Set(
                filteredBySize.map(item => String(item['Size']).trim()).filter(size => size)
            )];
            
            const options = uniqueSizes.map(size => ({ value: size, label: size }));
            
            if (options.length === 0) {
                 sizePaletEl.innerHTML = createOptionHtml([], 'Tidak ada Size Palet tersedia');
                 return;
            }

            sizePaletEl.innerHTML = createOptionHtml(options, 'Pilih Size Palet');
            sizePaletEl.disabled = false;
        }

        /**
         * Dipanggil saat Size Palet diubah. Merender kartu ID Palet.
         */
        function renderPalletIdCards() {
            const namaPalet = document.getElementById('namaPalet').value.trim();
            const sizePalet = document.getElementById('sizePalet').value.trim();
            const container = document.getElementById('pallet-id-card-container');
            
            // Bersihkan kartu, jaga pesan status
            container.innerHTML = `<p class="text-gray-500 col-span-full" id="id-card-status">Memfilter ID Palet...</p>`;
            
            // Reset state multi-select
            selectedPalletIds = []; 
            updateSelectedDisplay(); 

            if (!namaPalet || !sizePalet) {
                const existingStatusEl = document.getElementById('id-card-status');
                if (existingStatusEl) existingStatusEl.textContent = 'Pilih Nama Palet dan Size Palet terlebih dahulu.';
                return;
            }

            // 1. Filter data berdasarkan Nama Palet dan Size (menggunakan trim)
            const filteredData = masterPalletData.filter(item => 
                String(item['Nama Palet']).trim() === namaPalet && String(item['Size']).trim() === sizePalet
            );
            
            // Hapus pesan status placeholder
            const existingStatusEl = document.getElementById('id-card-status');
            if (existingStatusEl) existingStatusEl.remove();

            if (filteredData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full">Tidak ditemukan ID Palet yang sesuai untuk kriteria ini.</p>';
                return;
            }

            // 2. Render kartu untuk setiap ID Palet (hanya menampilkan ID)
            filteredData.forEach(item => {
                const idPalet = item['ID Palet'];
                
                const card = document.createElement('div');
                card.id = `card-${idPalet}`;
                // Diubah ke hover:ring-green-500
                card.className = `id-card rounded-lg text-center shadow-md font-mono font-semibold hover:ring-2 hover:ring-green-500 transition`;
                card.textContent = idPalet;
                
                // Tambahkan event listener untuk menoggel pilihan
                card.onclick = () => togglePalletSelection(idPalet);
                
                container.appendChild(card);
            });
        }
        
        /**
         * Menangani penambahan/penghapusan ID Palet dari array pilihan.
         */
        function togglePalletSelection(idPalet) {
            const index = selectedPalletIds.indexOf(idPalet);
            const card = document.getElementById(`card-${idPalet}`);

            if (index > -1) {
                // Hapus dari array (Deselect)
                selectedPalletIds.splice(index, 1);
                card.classList.remove('selected');
                showMessage('info', `ID Palet ${idPalet} dibatalkan.`);
            } else {
                // Tambahkan ke array (Select)
                selectedPalletIds.push(idPalet);
                card.classList.add('selected');
                showMessage('info', `ID Palet ${idPalet} ditambahkan. Total: ${selectedPalletIds.length}`);
            }
            
            updateSelectedDisplay();
        }
        
        /**
         * Memperbarui tampilan daftar ID yang sudah dipilih.
         */
        function updateSelectedDisplay() {
            const displayEl = document.getElementById('selected-ids-display');
            const submitCountEl = document.getElementById('submit-count');
            const selectedCountEl = document.getElementById('selected-count');
            
            // Perbarui jumlah di tombol submit dan header
            submitCountEl.textContent = selectedPalletIds.length;
            selectedCountEl.textContent = `(${selectedPalletIds.length} Palet Dipilih)`;

            if (selectedPalletIds.length === 0) {
                displayEl.innerHTML = '<span class="text-gray-400 text-sm">Belum ada palet yang dipilih.</span>';
                return;
            }

            // Tampilkan tag untuk setiap ID Palet yang dipilih
            displayEl.innerHTML = selectedPalletIds.map(id => 
                `<span class="selected-id-tag font-mono">${id}</span>`
            ).join('');
        }
        
        // --- HELPER FUNCTIONS ---
        
        /**
         * Helper untuk membuat input form
         */
        function createFormInput(label, id, type, required, placeholder, value = '', disabled = false) {
            const requiredAttr = required ? 'required' : '';
            const disabledAttr = disabled ? 'disabled' : '';
            const valueAttr = value ? `value="${value}"` : '';

            return `
                <label for="${id}" class="block text-sm font-medium text-gray-300 mb-1">
                    ${label} ${required ? '<span class="text-red-500">*</span>' : ''}
                </label>
                <input type="${type}" id="${id}" name="${id}" ${valueAttr} ${requiredAttr} ${disabledAttr}
                       class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:ring-green-500 focus:border-green-500 ${disabled ? 'opacity-50 cursor-not-allowed' : ''}"
                       placeholder="${placeholder}">
            `;
        }

        /**
         * Helper untuk membuat select form
         * @param {string} onChangeFunc - Nama fungsi yang akan dipanggil saat perubahan terjadi.
         */
        function createFormSelect(label, id, options, required, onChangeFunc = '') {
            const requiredAttr = required ? 'required' : '';
            const onChangeAttr = onChangeFunc ? `onchange="${onChangeFunc}()"` : '';
            
            return `
                <label for="${id}" class="block text-sm font-medium text-gray-300 mb-1">
                    ${label} ${required ? '<span class="text-red-500">*</span>' : ''}
                </label>
                <select id="${id}" name="${id}" ${requiredAttr} ${onChangeAttr}
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-green-500 focus:border-green-500">
                    ${createOptionHtml(options, `Pilih ${label}`)}
                </select>
            `;
        }
        
        /**
         * Helper untuk membuat HTML options
         */
        function createOptionHtml(options, defaultLabel) {
             const optionHtml = options.map(opt => 
                `<option value="${opt.value}">${opt.label}</option>`
            ).join('');
            
            return `<option value="" disabled selected>${defaultLabel}</option>${optionHtml}`;
        }
        
        /**
         * Fungsi untuk menampilkan pesan status (Sukses/Gagal/Info)
         */
        function showMessage(type, message) {
            const box = document.getElementById('transaction-message-box');
            if (!box) return;

            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-800', 'bg-green-800', 'bg-blue-800', 'text-white');

            if (type === 'success') {
                box.classList.add('bg-green-800', 'text-white');
            } else if (type === 'error') {
                box.classList.add('bg-red-800', 'text-white');
            } else if (type === 'loading' || type === 'info') {
                 box.classList.add('bg-blue-800', 'text-white');
            }
        }

        /**
         * Handler untuk submit form Transaksi Palet (Multi-Palet)
         */
        async function submitTransaction(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('submit-btn');
            // Dapatkan kedua elemen span secara terpisah untuk menghindari error
            const submitBtnTextEl = document.getElementById('submit-btn-text');
            const submitCountEl = document.getElementById('submit-count');
            
            const formData = new FormData(form);
            
            if (selectedPalletIds.length === 0) {
                showMessage('error', '‚ùå Harap pilih minimal satu ID Palet dari kartu yang tersedia.');
                return;
            }

            submitBtn.disabled = true;
            // Hanya ubah teks, bukan seluruh tombol
            submitBtnTextEl.textContent = 'Mengirim...';
            submitCountEl.textContent = selectedPalletIds.length; 
            
            showMessage('loading', `Mengirim data untuk ${selectedPalletIds.length} palet, mohon tunggu...`);

            // --- PERUBAHAN LOGIKA PENGIRIMAN DATA ---

            // 1. Ambil semua data input dari form (gunakan trim untuk keamanan)
            const namaPalet = formData.get('namaPalet').trim();
            const sizePalet = formData.get('sizePalet').trim();
            const tanggalTransaksi = formData.get('tanggalTransaksi').trim();
            const jenisTransaksi = formData.get('jenisTransaksi').trim();
            const keterangan = formData.get('keterangan').trim() || '-';
            
            // 2. Gabungkan ID Palet yang dipilih menjadi satu string, dipisahkan koma
            const idPaletString = selectedPalletIds.join(',');

            // 3. Tambahkan info waktu 
            const now = new Date();
            const jamTransaksi = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // 4. Buat SATU objek transaksi tunggal untuk batch ini
            const batchTransaction = {
                // Kolom di Google Sheet harus sesuai urutan:
                'Nama Palet': namaPalet,
                'Size': sizePalet, 
                'Tanggal Transaksi': tanggalTransaksi,
                'Jenis Transaksi': jenisTransaksi,
                'ID Palet': idPaletString, // Data yang digabungkan
                'Jumlah Palet': selectedPalletIds.length, // Tambahan info jumlah
                'Jam Transaksi': jamTransaksi, // Tambahan info jam
                'Keterangan': keterangan,
            };

            // 5. Siapkan array transaksi (hanya berisi satu objek)
            const transactionsToSend = [batchTransaction];
            
            console.log(`Satu Transaksi Batch yang akan dikirim ke sheet ${TRANSACTION_SHEET_NAME}:`, batchTransaction);
            
            // 6. Kirim array data ke Apps Script
            const payload = {
                sheetName: TRANSACTION_SHEET_NAME, // Target sheet name
                transactions: transactionsToSend, // Array berisi SATU objek batch
                submittedBy: userId,
                timestamp: now.toLocaleString('id-ID'),
            };

            try {
                // ** PERHATIAN: MOCK API URL DIGUNAKAN. GANTI DENGAN ASLI! **
                await fetch(MOCK_API_DEPLOY_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload), // Kirim payload lengkap
                });
                
                // Beri penundaan sedikit untuk simulasi kiriman
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                // Pesan sukses disesuaikan
                showMessage('success', `‚úÖ Berhasil mencatat 1 Transaksi Batch (untuk ${selectedPalletIds.length} palet) ke ${TRANSACTION_SHEET_NAME}!`);
                form.reset();
                
                // Reset Dropdown, State, dan Kartu (Logika ini tetap sama)
                selectedPalletIds = [];
                updateSelectedDisplay(); 
                document.getElementById('sizePalet').innerHTML = createOptionHtml([], 'Pilih Size Palet');
                document.getElementById('sizePalet').disabled = true;
                document.getElementById('pallet-id-card-container').innerHTML = '<p class="text-gray-500 col-span-full" id="id-card-status">Pilih Nama Palet dan Size Palet terlebih dahulu.</p>';


            } catch (error) {
                console.error("Kesalahan saat mengirim data:", error);
                showMessage('error', `‚ùå Gagal menyimpan transaksi batch. Pastikan Apps Script (sheet ${TRANSACTION_SHEET_NAME}) siap menerima data ini. Detail error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                // Reset teks tombol dengan benar
                submitBtnTextEl.textContent = 'Kirim Transaksi';
                // Reset jumlah di tombol
                if(selectedPalletIds.length === 0) {
                    submitCountEl.textContent = '0';
                }
            }
        }
        
        /**
         * Template Header Universal
         */
        function createHeader(title, backPage) {
             return `
                <header class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3" id="header-${title.toLowerCase().replace(/\s/g, '-')}">
                    <div class="flex items-center">
                        <button onclick="navigate('${backPage}')" class="text-gray-400 hover:text-green-400 transition mr-4">
                            <!-- Icon Home/Kembali -->
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                        </button>
                        <h1 class="text-2xl font-bold text-green-400">${title}</h1>
                    </div>
                    <!-- Menggunakan ID yang konsisten untuk pengambilan data -->
                    <span id="${getStatusMessageId(title)}" class="text-sm text-gray-400">Siap mencatat</span>
                </header>
            `;
        }
        
        /**
         * Template Kartu Ringkasan
         */
        function createSummaryCard(value, title, colorClass) {
            return `
                <div class="bg-zinc-800 p-5 rounded-xl shadow-xl border-t-4 border-green-500">
                    <p class="text-sm text-gray-400 font-medium">${title}</p>
                    <p class="text-4xl font-extrabold mt-1 ${colorClass}">${value}</p>
                    <p class="text-xs text-gray-500 mt-2">Data diambil dari sheet "Ringkasan Stok Palet"</p>
                </div>
            `;
        }
        
        /**
         * Template Kartu Ringkasan Placeholder
         */
        function createSummaryCardPlaceholder(value, title) {
            return `
                <div class="bg-zinc-800 p-5 rounded-xl shadow-xl border-t-4 border-gray-500">
                    <p class="text-sm text-gray-400 font-medium">${title}</p>
                    <p class="text-4xl font-extrabold mt-1 text-gray-500">${value}</p>
                    <p class="text-xs text-gray-600 mt-2">Menunggu data...</p>
                </div>
            `;
        }

        // --- 10. TAMPILAN PLACEHOLDER MENU LAIN ---
        function createPlaceholderView(title, subtitle) {
            return `
                <div class="p-6 app-view">
                    ${createHeader(title, 'dashboard')}
                    <div class="bg-zinc-800 p-8 rounded-xl shadow-lg text-center mt-10">
                        <h2 class="text-xl font-semibold mb-2 text-gray-200">Fitur ${title}</h2>
                        <p class="text-gray-400 mb-4">${subtitle} - Halaman ini sedang dalam pengembangan.</p>
                        <p class="text-sm text-gray-500">Saat ini menu "Master Palet", "Stock Palet", dan "Transaksi Palet" sudah terintegrasi.</p>
                        <button onclick="navigate('dashboard')" class="mt-6 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition">
                            Kembali ke Menu Utama
                        </button>
                    </div>
                </div>
            `;
        }

        // --- 11. EKSEKUSI APLIKASI ---
        window.onload = () => {
            window.navigate = navigate;
            window.submitTransaction = submitTransaction; 
            window.updateSizePallet = updateSizePallet;
            window.renderPalletIdCards = renderPalletIdCards;
            window.togglePalletSelection = togglePalletSelection; 
            
            initializeFirebase(); 
        };

    </script>
</body>
</html>
