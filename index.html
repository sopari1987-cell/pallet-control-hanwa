<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Palet Data Viewer</title>
    <!-- Memuat Tailwind CSS untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font default */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Abu-abu muda */
        }
        /* Style untuk container utama (menggunakan flexbox untuk responsivitas) */
        .data-container {
            display: grid;
            gap: 1.5rem; /* Spasi 6 (tailwind) */
            padding: 1.5rem;
        }
        /* Untuk tampilan desktop, gunakan 3 kolom */
        @media (min-width: 1024px) {
            .data-container {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        /* Untuk tampilan tablet, gunakan 2 kolom */
        @media (min-width: 640px) and (max-width: 1023px) {
            .data-container {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>

    <!-- Header Aplikasi -->
    <header class="bg-indigo-600 shadow-md p-4 mb-6">
        <h1 class="text-3xl font-bold text-white text-center">Master Data Palet</h1>
    </header>

    <!-- Loading State dan Pesan Kesalahan -->
    <div id="status-message" class="text-center p-4 text-xl font-semibold text-gray-700">
        Memuat data palet dari Google Sheet...
    </div>

    <!-- Container untuk Kartu Palet (Tampilan Utama) -->
    <div id="pallet-cards-container" class="data-container max-w-7xl mx-auto">
        <!-- Kartu Palet akan dimasukkan di sini oleh JavaScript -->
    </div>

    <!-- Bagian Data Tabel (Opsional/Detail) -->
    <div class="max-w-7xl mx-auto p-6 mt-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Detail Data Palet (Tabel)</h2>
        <div id="table-container" class="bg-white shadow-lg rounded-xl overflow-x-auto p-4">
            <!-- Tabel data akan dimasukkan di sini oleh JavaScript -->
            <table id="pallet-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <!-- Header tabel akan diisi di sini -->
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Baris data akan diisi di sini -->
                </tbody>
            </table>
        </div>
    </div>


    <!-- Firebase dan Logic JavaScript -->
    <script type="module">
        // --- 1. SETUP FIREBASE (MANDATORI SESUAI ATURAN PLATFORM) ---
        // Variabel global __app_id, __firebase_config, dan __initial_auth_token
        // disediakan oleh Canvas environment.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;

        // Inisialisasi Firebase dan Autentikasi
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentikasi menggunakan token kustom atau anonim
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase dan Autentikasi berhasil diinisialisasi.");
            } catch (error) {
                console.error("Kesalahan saat inisialisasi Firebase:", error);
                // Lanjutkan, karena fokus utama adalah fetch Google Sheet
            }
        }

        // --- 2. KONFIGURASI GOOGLE SHEET ---
        // GANTI NILAI DI BAWAH INI DENGAN DATA SHEET ANDA YANG SEBENARNYA
        const GOOGLE_SHEET_ID = '1Q-6x0B7Y-p6Dq3s6Uv2P4hT7W5Rz8n0O9h1C2y3I4o5'; // GANTI dengan ID Google Sheet Anda
        const SHEET_NAME = 'MasterPalet'; // GANTI dengan Nama Sheet Anda (misalnya: Sheet1)
        const RANGE = 'A:D'; // Opsional: Tentukan kolom yang ingin diambil, misalnya A:D

        // URL GViz (Google Visualization API Query)
        const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&range=${RANGE}`;

        const statusMessageEl = document.getElementById('status-message');
        const cardsContainerEl = document.getElementById('pallet-cards-container');
        const tableHeaderEl = document.querySelector('#pallet-table thead');
        const tableBodyEl = document.querySelector('#pallet-table tbody');

        // --- 3. FUNGSI FETCH DAN PARSE DATA ---

        /**
         * Mengambil data dari Google Sheet menggunakan API GViz.
         * @returns {Promise<Object[]|null>} Array data baris atau null jika gagal.
         */
        async function fetchSpreadsheetData() {
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) {
                    throw new Error(`Gagal fetch data: Status ${response.status}`);
                }
                
                // Text response dari GViz API harus diproses. 
                // Formatnya: /*O_o*/\ngoogle.visualization.Query.setResponse({...});
                const text = await response.text();
                
                // Menghilangkan awalan dan akhiran yang tidak perlu untuk mendapatkan JSON murni
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);
                
                if (data.status !== 'ok') {
                     throw new Error(`Status query tidak OK: ${data.errors ? data.errors[0].message : 'Kesalahan tidak diketahui'}`);
                }

                return parseGVizData(data);
                
            } catch (error) {
                console.error("Kesalahan saat mengambil data Google Sheet:", error);
                statusMessageEl.textContent = `ðŸš¨ GAGAL MEMUAT DATA: ${error.message}. Pastikan ID Sheet, Nama Sheet, dan Izin akses publik sudah benar.`;
                cardsContainerEl.innerHTML = '';
                return null;
            }
        }

        /**
         * Mengurai struktur data GViz menjadi array objek JavaScript yang sederhana.
         * @param {Object} data - Objek respons GViz yang telah diparsing.
         * @returns {Object[]} Array data baris.
         */
        function parseGVizData(data) {
            const columns = data.table.cols.map(col => ({
                id: col.id,
                label: col.label || col.id // Menggunakan label atau id sebagai header
            }));
            const rows = data.table.rows;
            const result = [];

            for (const row of rows) {
                const rowObject = {};
                for (let i = 0; i < columns.length; i++) {
                    const colId = columns[i].label; // Gunakan label sebagai kunci objek
                    // Nilai data ada di 'v'
                    rowObject[colId] = row.c[i] ? (row.c[i].f || row.c[i].v) : '';
                }
                result.push(rowObject);
            }
            
            // Kolom header/label
            const headers = columns.map(c => c.label);
            
            return { data: result, headers: headers };
        }


        // --- 4. FUNGSI RENDERING (DISPLAY) DATA ---

        /**
         * Menampilkan data yang sudah diurai ke dalam kartu dan tabel.
         * @param {Object} parsedData - Objek yang berisi { data: Array, headers: Array }.
         */
        function displayData(parsedData) {
            const { data, headers } = parsedData;
            
            if (data.length === 0) {
                statusMessageEl.textContent = "Data tidak ditemukan di Sheet yang ditentukan.";
                return;
            }

            statusMessageEl.textContent = `Menampilkan ${data.length} data Palet.`;
            cardsContainerEl.innerHTML = ''; // Kosongkan container kartu

            // 4a. Rendering Kartu Palet
            data.forEach(item => {
                const card = createPalletCard(item);
                cardsContainerEl.appendChild(card);
            });

            // 4b. Rendering Tabel Detail
            renderPalletTable(data, headers);
        }

        /**
         * Membuat elemen kartu untuk setiap data Palet.
         * @param {Object} item - Objek data Palet (misalnya: { "Pallet ID": "P-001", "Status": "Tersedia", ... }).
         * @returns {HTMLElement} Elemen div kartu yang sudah di-styling.
         */
        function createPalletCard(item) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-xl p-6 transition duration-300 hover:shadow-2xl hover:scale-[1.02] border-t-4 border-indigo-500';

            // Menentukan warna status
            const status = item['Status'] || 'Tidak Diketahui';
            let statusColor = 'bg-gray-200 text-gray-800';
            if (status.toLowerCase().includes('tersedia')) {
                statusColor = 'bg-green-100 text-green-700 border-green-500';
            } else if (status.toLowerCase().includes('dipakai')) {
                statusColor = 'bg-yellow-100 text-yellow-700 border-yellow-500';
            } else if (status.toLowerCase().includes('rusak')) {
                statusColor = 'bg-red-100 text-red-700 border-red-500';
            }

            // Membangun konten kartu
            let content = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-2xl font-extrabold text-indigo-700 leading-tight">
                        ${item['Pallet ID'] || 'N/A'}
                    </h3>
                    <span class="text-sm font-semibold px-3 py-1 rounded-full ${statusColor} border border-opacity-50">
                        ${status}
                    </span>
                </div>
                <div class="space-y-2 text-gray-600">
            `;

            // Tambahkan semua field data ke dalam kartu (kecuali Pallet ID dan Status yang sudah di atas)
            const keys = Object.keys(item).filter(key => key !== 'Pallet ID' && key !== 'Status');
            keys.forEach(key => {
                content += `
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-medium text-gray-500">${key}:</span>
                        <span class="font-semibold text-gray-700">${item[key] || '-'}</span>
                    </div>
                `;
            });

            content += `
                </div>
                <button class="mt-4 w-full bg-indigo-500 text-white py-2 rounded-lg font-bold hover:bg-indigo-600 transition duration-150 text-sm">
                    Lihat Detail &rarr;
                </button>
            `;

            card.innerHTML = content;
            return card;
        }

        /**
         * Merender data Palet ke dalam elemen tabel.
         * @param {Object[]} data - Array data Palet.
         * @param {string[]} headers - Array header kolom.
         */
        function renderPalletTable(data, headers) {
            // Render Header Tabel
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHeaderEl.innerHTML = '';
            tableHeaderEl.appendChild(headerRow);

            // Render Body Tabel
            tableBodyEl.innerHTML = '';
            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                    td.textContent = item[header] || '-';
                    tr.appendChild(td);
                });
                tableBodyEl.appendChild(tr);
            });
        }

        // --- 5. EKSEKUSI APLIKASI ---

        // Fungsi utama untuk menjalankan aplikasi
        async function runApplication() {
            await initializeFirebase(); // Inisialisasi Firebase terlebih dahulu
            
            const parsedData = await fetchSpreadsheetData();
            
            if (parsedData) {
                displayData(parsedData);
            }
        }

        window.onload = runApplication;

    </script>

    <!-- Memuat icon (lucide-react, meskipun ini HTML, kita gunakan font-awesome placeholder jika diperlukan) -->
    <!-- Tidak perlu memuat icon eksternal karena menggunakan teks/Tailwind -->
</body>
</html>
