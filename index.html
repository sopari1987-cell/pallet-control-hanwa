<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kontrol Palet Hanwa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-app {
            max-width: 1200px;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #0d47a1;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
            <p class="text-white mt-3 text-lg">Memuat...</p>
        </div>
    </div>

    <div class="container-app mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">Kontrol Palet Hanwa (Demo)</h1>

        <!-- Authentication Status -->
        <div id="auth-status" class="bg-blue-100 p-3 rounded-lg text-blue-800 mb-6 flex justify-between items-center">
            <span>Status: <span id="user-status" class="font-semibold">Memuat...</span></span>
            <span id="user-id-display" class="text-sm font-mono bg-blue-200 px-2 py-1 rounded"></span>
        </div>

        <!-- Tabs -->
        <div class="flex mb-6 border-b border-gray-300">
            <button onclick="switchTab('master')" class="tab-btn p-3 font-semibold text-sm md:text-base border-b-2 border-blue-600 text-blue-600 transition duration-150 ease-in-out" id="tab-master">Master Palet</button>
            <button onclick="switchTab('transaction')" class="tab-btn p-3 font-semibold text-sm md:text-base text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out" id="tab-transaction">Transaksi Palet</button>
        </div>

        <!-- Master Palet Tab Content -->
        <div id="content-master" class="tab-content">
            <!-- Master Palet Form -->
            <div class="card bg-white p-6 rounded-xl mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Input Master Palet Baru</h2>
                <form id="master-palet-form" onsubmit="window.handleMasterPaletSubmit(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="masterPaletId" name="masterPaletId" placeholder="ID Palet (Ex: HNW-A101)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <select id="masterPaletType" name="masterPaletType" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Tipe Palet</option>
                            <option value="Standard">Standard</option>
                            <option value="Heavy Duty">Heavy Duty</option>
                            <option value="Lightweight">Lightweight</option>
                        </select>
                        <input type="text" id="masterPaletLocation" name="masterPaletLocation" placeholder="Lokasi Awal (Ex: Gudang A)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input type="number" id="masterPaletCapacity" name="masterPaletCapacity" placeholder="Kapasitas Angkut (Kg)" value="1000" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="mt-6 w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-bold rounded-lg btn-primary hover:bg-blue-700">
                        Simpan Master Palet
                    </button>
                </form>
            </div>

            <!-- Master Palet List -->
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Daftar Master Palet (<span id="master-palet-count">0</span>)</h2>
                <div class="table-container overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Palet</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kapasitas (Kg)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terakhir Diperbarui</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="master-palet-list" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be inserted here by JavaScript -->
                            <tr><td colspan="7" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transaksi Palet Tab Content -->
        <div id="content-transaction" class="tab-content hidden">
            <!-- Transaksi Form -->
            <div class="card bg-white p-6 rounded-xl mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Input Transaksi Palet</h2>
                <form id="transaction-form" onsubmit="window.handleTransactionSubmit(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="transactionPaletId" name="transactionPaletId" placeholder="ID Palet (Ex: HNW-A101)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <select id="transactionType" name="transactionType" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Jenis Transaksi</option>
                            <option value="Incoming">Masuk (Incoming)</option>
                            <option value="Outgoing">Keluar (Outgoing)</option>
                        </select>
                        <input type="text" id="transactionLocation" name="transactionLocation" placeholder="Lokasi Baru (Ex: Line Produksi 1)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input type="text" id="transactionNotes" name="transactionNotes" placeholder="Catatan Tambahan (Opsional)" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="mt-6 w-full md:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-lg btn-primary hover:bg-green-700">
                        Catat Transaksi
                    </button>
                </form>
            </div>

            <!-- Transaction List -->
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Riwayat Transaksi Palet (<span id="transaction-count">0</span>)</h2>
                <div class="table-container overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Palet</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe Transaksi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi Baru</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be inserted here by JavaScript -->
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl p-6 w-11/12 max-w-sm card">
            <h3 id="modal-title" class="text-lg font-bold mb-3">Pesan</h3>
            <p id="modal-body" class="text-gray-700 mb-4"></p>
            <button onclick="document.getElementById('message-modal').classList.remove('opacity-100', 'pointer-events-auto'); document.getElementById('message-modal').classList.add('opacity-0', 'pointer-events-none');" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg btn-primary">Tutup</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // *** FIX APPLIED HERE: Added 'doc', 'setDoc', 'updateDoc', 'addDoc', etc. to imports ***
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, limit, serverTimestamp, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const masterPaletCollectionPath = `artifacts/${appId}/public/data/masterPalets`;
        const transactionCollectionPath = `artifacts/${appId}/public/data/transactions`;

        // Utility function to show custom modal messages
        window.showMessageModal = (message, type = 'info') => {
            const modal = document.getElementById('message-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = type === 'error' ? 'Gagal!' : (type === 'success' ? 'Berhasil!' : 'Pesan');
            body.textContent = message;

            // Optional: change title color based on type
            title.className = `text-lg font-bold mb-3 ${type === 'error' ? 'text-red-600' : 'text-blue-600'}`;

            modal.classList.add('opacity-100', 'pointer-events-auto');
            modal.classList.remove('opacity-0', 'pointer-events-none');
        };

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        const initializeFirebase = async () => {
            try {
                // Initialize App and Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-status').textContent = 'Terkoneksi';
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        console.log(`Autentikasi selesai. User ID: ${userId}`);
                    } else {
                         // Sign in anonymously if no token is available or user is signed out
                        userId = null;
                        await signInAnonymously(auth);
                        // The onAuthStateChanged listener will fire again with the new anonymous user
                    }

                    if (user || !initialAuthToken) {
                        // This block ensures we only proceed after the initial auth check/sign-in
                        isAuthReady = true;
                        document.getElementById('loading-overlay').classList.add('hidden');
                        startFirestoreListeners();
                    }
                });

                // If initialAuthToken is provided, use it for custom sign-in
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                console.log(`Master Palet Collection Path: ${masterPaletCollectionPath}`);
            } catch (error) {
                console.error("Gagal inisialisasi Firebase atau autentikasi:", error);
                document.getElementById('user-status').textContent = 'Gagal';
                document.getElementById('loading-overlay').classList.add('hidden');
                showMessageModal(`Gagal terhubung ke sistem. Cek konsol untuk detail error.`, 'error');
            }
        };

        // --- FIRESTORE LISTENERS ---
        const startFirestoreListeners = () => {
            if (!isAuthReady || !userId) return;

            // 1. Master Palet Listener
            onSnapshot(collection(db, masterPaletCollectionPath), (snapshot) => {
                const palets = [];
                snapshot.forEach(doc => palets.push(doc.data()));
                renderMasterPalets(palets);
                console.log(`Data Master Palet diperbarui: ${palets.length}`);
            }, (error) => {
                console.error("Gagal mendengarkan Master Palets:", error);
            });

            // 2. Transaction Listener
            // Note: Sorting is done client-side to avoid index requirement in Firestore
            onSnapshot(collection(db, transactionCollectionPath), (snapshot) => {
                let transactions = [];
                snapshot.forEach(doc => transactions.push(doc.data()));

                // Sort by timestamp (descending) client-side
                transactions.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeB - timeA;
                });

                renderTransactions(transactions);
                console.log(`Data Transaksi Palet diperbarui: ${transactions.length}`);
            }, (error) => {
                console.error("Gagal mendengarkan Transaksi Palet:", error);
            });
        };

        // --- RENDERING FUNCTIONS ---
        const renderMasterPalets = (palets) => {
            const list = document.getElementById('master-palet-list');
            document.getElementById('master-palet-count').textContent = palets.length;
            list.innerHTML = ''; // Clear existing rows

            if (palets.length === 0) {
                list.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Belum ada data Master Palet.</td></tr>';
                return;
            }

            palets.forEach(palet => {
                const row = document.createElement('tr');
                const statusClass = palet.status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${palet.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${palet.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${palet.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${palet.location}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${palet.capacity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(palet.lastUpdated).toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="window.handleDeleteMasterPalet('${palet.id}')" class="text-red-600 hover:text-red-900 ml-2">Hapus</button>
                    </td>
                `;
                list.appendChild(row);
            });
        };

        const renderTransactions = (transactions) => {
            const list = document.getElementById('transaction-list');
            document.getElementById('transaction-count').textContent = transactions.length;
            list.innerHTML = ''; // Clear existing rows

            if (transactions.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada data Transaksi Palet.</td></tr>';
                return;
            }

            transactions.forEach(tx => {
                const row = document.createElement('tr');
                const typeClass = tx.type === 'Incoming' ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';

                const timestamp = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleString('id-ID') : 'N/A';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${timestamp}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tx.paletId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${typeClass}">${tx.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.location}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${tx.notes || ''}">${tx.notes || '-'}</td>
                `;
                list.appendChild(row);
            });
        };

        // --- MASTER PALET HANDLERS ---
        window.handleMasterPaletSubmit = async (event) => {
            event.preventDefault();
            if (!isAuthReady || !userId) {
                showMessageModal("Sistem belum siap. Tunggu autentikasi selesai.", 'error');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);

            const newPaletId = formData.get('masterPaletId').toUpperCase().trim();
            if (!newPaletId) {
                showMessageModal("ID Palet tidak boleh kosong.", 'error');
                return;
            }

            const paletData = {
                id: newPaletId,
                type: formData.get('masterPaletType'),
                status: 'Available', // Default status for a new pallet
                location: formData.get('masterPaletLocation'),
                capacity: parseInt(formData.get('masterPaletCapacity') || 1, 10),
                lastUpdated: new Date().toISOString(),
                createdBy: userId,
            };

            try {
                // Use doc() from the import to create a document reference with a specific ID
                const masterPaletRef = doc(db, masterPaletCollectionPath, newPaletId);

                // Use setDoc to create/overwrite the document
                await setDoc(masterPaletRef, paletData);

                showMessageModal(`Master Palet ${newPaletId} berhasil disimpan!`, 'success');
                form.reset();
            } catch (error) {
                console.error("Gagal menyimpan Palet. Detail Error:", error);
                showMessageModal(`Gagal menyimpan Palet: ${error.message}`, 'error');
            }
        };

        window.handleDeleteMasterPalet = async (paletId) => {
            if (!isAuthReady || !userId) {
                showMessageModal("Sistem belum siap.", 'error');
                return;
            }

            // Simple custom "confirmation" using the modal
            const confirmed = window.prompt(`Yakin ingin menghapus Master Palet ID: ${paletId}? Ketik 'HAPUS' untuk konfirmasi.`);
            if (confirmed !== 'HAPUS') {
                return;
            }

            try {
                // Check if there are any transactions associated with this pallet ID first (optional safety check)
                const txQuery = query(collection(db, transactionCollectionPath), where("paletId", "==", paletId), limit(1));
                const txSnapshot = await getDocs(txQuery);

                if (!txSnapshot.empty) {
                     showMessageModal(`Palet ${paletId} tidak dapat dihapus karena memiliki riwayat transaksi.`, 'error');
                     return;
                }

                await deleteDoc(doc(db, masterPaletCollectionPath, paletId));
                showMessageModal(`Master Palet ${paletId} berhasil dihapus.`, 'success');
            } catch (error) {
                console.error("Gagal menghapus Palet:", error);
                showMessageModal(`Gagal menghapus Palet: ${error.message}`, 'error');
            }
        };

        // --- TRANSACTION HANDLERS ---
        window.handleTransactionSubmit = async (event) => {
            event.preventDefault();
            if (!isAuthReady || !userId) {
                showMessageModal("Sistem belum siap. Tunggu autentikasi selesai.", 'error');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);

            const paletId = formData.get('transactionPaletId').toUpperCase().trim();
            const transactionType = formData.get('transactionType');
            const newLocation = formData.get('transactionLocation');
            const notes = formData.get('transactionNotes');

            if (!paletId || !transactionType || !newLocation) {
                showMessageModal("Semua kolom transaksi harus diisi.", 'error');
                return;
            }

            try {
                // Use a transaction to ensure atomic update of both Master Palet and Transaction Record
                await runTransaction(db, async (transaction) => {
                    const masterPaletRef = doc(db, masterPaletCollectionPath, paletId);
                    const masterPaletDoc = await transaction.get(masterPaletRef);

                    if (!masterPaletDoc.exists()) {
                        throw new Error(`Master Palet ID ${paletId} tidak ditemukan.`);
                    }

                    const currentPaletData = masterPaletDoc.data();
                    const newStatus = transactionType === 'Incoming' ? 'Available' : 'In Use';

                    // 1. Update Master Palet
                    const updatedPaletData = {
                        location: newLocation,
                        status: newStatus,
                        lastUpdated: new Date().toISOString(),
                    };
                    transaction.update(masterPaletRef, updatedPaletData);

                    // 2. Create Transaction Record
                    const newTx = {
                        paletId: paletId,
                        type: transactionType,
                        location: newLocation,
                        notes: notes,
                        timestamp: serverTimestamp(),
                        previousLocation: currentPaletData.location,
                        userId: userId,
                    };
                    const transactionCollectionRef = collection(db, transactionCollectionPath);
                    transaction.set(doc(transactionCollectionRef), newTx); // Use set(doc()) to add a new document with auto-ID

                });

                showMessageModal(`Transaksi Palet ${paletId} (${transactionType}) berhasil dicatat.`, 'success');
                form.reset();

            } catch (error) {
                console.error("Gagal mencatat transaksi. Detail Error:", error);
                showMessageModal(`Gagal mencatat transaksi: ${error.message}`, 'error');
            }
        };


        // --- UI & INITIALIZATION ---
        window.onload = () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            initializeFirebase();
        };

        window.switchTab = (tabName) => {
            const tabs = ['master', 'transaction'];
            tabs.forEach(tab => {
                const btn = document.getElementById(`tab-${tab}`);
                const content = document.getElementById(`content-${tab}`);
                if (tab === tabName) {
                    btn.classList.add('border-blue-600', 'text-blue-600');
                    btn.classList.remove('text-gray-500', 'hover:text-gray-700', 'border-gray-300');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.remove('border-blue-600', 'text-blue-600');
                    btn.classList.add('text-gray-500', 'hover:text-gray-700', 'border-gray-300');
                    content.classList.add('hidden');
                }
            });
        };

    </script>
</body>
</html>
