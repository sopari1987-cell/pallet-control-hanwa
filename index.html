<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrol Palet Hanwa</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js untuk Dashboard Analitik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Mengatur font default dan dark mode (Tema Hijau/Hitam/Putih) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #18181b; /* Warna background gelap (mendekati hitam - Zinc 900) */
            color: #ffffff; /* Warna teks terang (Putih) */
        }
        /* Style untuk kartu menu */
        .menu-card {
            background-color: #27272a; /* Zinc 800 */
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .menu-card:hover {
            background-color: #3f3f46; /* Zinc 700 */
            transform: translateY(-3px);
            border-color: #22c55e; /* Border hijau (Green 500) saat hover */
        }
        .icon {
            color: #9ca3af; /* Warna ikon default (abu-abu terang) */
            transition: color 0.3s ease-in-out;
        }
        .menu-card:hover .icon {
            color: #22c55e; /* Warna ikon hijau (Green 500) saat hover */
        }
        /* Style untuk App View */
        .app-view {
            background-color: #18181b; /* Zinc 900 */
            color: #ffffff; /* Putih */
            min-height: 100vh;
        }
        /* Style untuk Halaman Login */
        .login-view {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .login-card {
            background-color: #27272a; /* Zinc 800 */
            border-top: 4px solid #22c55e; /* Aksen hijau */
        }
        
        /* Style untuk Tabel */
        .pallet-table {
            background-color: #27272a; /* Zinc 800 */
        }
        .pallet-table th {
            background-color: #18181b; /* Zinc 900 (Lebih gelap) */
            color: #9ca3af;
        }
        /* Baris header (judul) */
        .pallet-table thead tr:first-child th {
            border-bottom: 2px solid #22c55e; /* Garis bawah hijau (Green 500) */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Baris filter (input) */
        .pallet-table thead tr:nth-child(2) th {
            background-color: #18181b; /* Pastikan background sama */
            border-bottom: 1px solid #3f3f46; /* Garis bawah abu-abu */
            position: sticky;
            top: 37px; 
            z-index: 10;
        }
        .pallet-table tr:nth-child(even) {
            background-color: #3f3f46; /* Zinc 700 */
        }
        .color-green { color: #34d399; } 
        .color-orange { color: #f97316; } 
        .color-red { color: #f87171; } 
        
        /* Style untuk tombol */
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); /* Bayangan hijau */
        }
        /* Style untuk ID Palet Card */
        .id-card {
            background-color: #18181b; /* Zinc 900 */
            border: 1px solid #22c55e; /* Border hijau (Green 500) */
            transition: all 0.2s;
            cursor: pointer;
            padding: 0.5rem 0.75rem; 
            font-size: 0.875rem; /* text-sm */
        }
        .id-card.selected {
            background-color: #22c55e; /* Warna hijau (Green 500) jika terpilih */
            color: #18181b; /* Teks gelap agar kontras di atas hijau */
            border-color: #16a34a; /* Green 600 */
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
        }
        .selected-id-tag {
            background-color: #22c55e; /* Green 500 */
            color: #18181b; /* Teks gelap */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        /* Style untuk Chart Container */
        .chart-container {
            background-color: #27272a; /* Zinc 800 */
            padding: 1.5rem;
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            height: 400px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    </style>
</head>
<body>

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container" class="min-h-screen"></div>

    <!-- Firebase, Navigasi, dan Logic JavaScript -->
    <script type="module">
        // --- 1. SETUP FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        
        // --- DATA STATE GLOBAL ---
        let currentUser = null; 
        let masterPalletData = []; 
        let masterPalletHeaders = []; 
        let historyPalletData = []; 
        let historyPalletHeaders = []; 
        let selectedPalletIds = []; 
        let ambangBatasData = []; 
        let criticalStockAlerts = []; 
        // Flag fetch dihapus/direset saat navigasi
        let isMasterDataFetched = false;
        let isHistoryDataFetched = false;
        let isAmbangBatasDataFetched = false;
        let chartInstances = {
            palletAging: null,
            palletCondition: null,
            palletVelocity: null
        };


        /**
         * Inisialisasi Firebase
         */
        async function initializeFirebase() {
            if (auth) return; 

            return new Promise((resolve) => {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    const authCallback = (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase Auth State Changed. User ID:", userId);
                            resolve();
                        } else {
                            signInAnonymously(auth).then(cred => {
                                userId = cred.user.uid;
                                console.log("Anonymous User ID:", userId);
                                resolve();
                            }).catch(err => {
                                 console.error("Anonymous sign-in failed:", err);
                                 userId = 'guest-' + crypto.randomUUID().substring(0, 8);
                                 resolve();
                            });
                        }
                    };
                    
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        unsubscribe(); 
                        if (initialAuthToken) {
                            signInWithCustomToken(auth, initialAuthToken).then(cred => {
                                userId = cred.user.uid;
                                resolve();
                            }).catch(err => {
                                console.warn("Custom token failed, trying anonymous.", err);
                                authCallback(null);
                            });
                        } else {
                            authCallback(user);
                        }
                    });
                } catch (error) {
                    console.error("Kesalahan saat inisialisasi Firebase:", error);
                    userId = 'guest-error-' + crypto.randomUUID().substring(0, 8);
                    resolve();
                }
            });
        }
        
        // --- 2. NAVIGASI STATE ---
        function navigate(page) {
            localStorage.setItem('currentPage', page);
            if (page !== 'transaksiPalet') {
                selectedPalletIds = [];
            }
            // Reset Flag Data untuk memaksa Refresh
            isMasterDataFetched = false;
            isHistoryDataFetched = false;
            isAmbangBatasDataFetched = false;
            
            masterPalletData = [];
            historyPalletData = [];
            ambangBatasData = [];
            
            renderApp(page);
        }

        // --- 3. RENDERING UTAMA ---
        function renderApp(page) {
            const container = document.getElementById('app-container');
            
            if (page !== 'login' && !currentUser) {
                page = 'login';
            }
            
            container.innerHTML = ''; 

            switch (page) {
                case 'login':
                    container.innerHTML = createLoginView();
                    break;
                case 'masterPalet':
                    container.innerHTML = createMasterPalletView();
                    fetchMasterPalletData(); 
                    break;
                case 'stockPalet':
                    container.innerHTML = createStockPalletView(); 
                    fetchStockPalletData(); 
                    break;
                case 'transaksiPalet':
                    selectedPalletIds = []; 
                    container.innerHTML = createTransactionPalletView();
                    fetchMasterDataForTransaction(); 
                    break;
                case 'historyPalet':
                    container.innerHTML = createHistoryPalletView();
                    fetchHistoryPalletData();
                    break;
                case 'analyticsDashboard':
                    container.innerHTML = createAnalyticsDashboardView();
                    loadAnalyticsData(); 
                    break;
                case 'stoPalet':
                    container.innerHTML = createPlaceholderView('STO Palet', 'Stock Taking Palet');
                    break;
                case 'dashboard':
                default:
                    container.innerHTML = createDashboardView();
                    loadDashboardData(); 
                    break;
            }
        }
        
        function getStatusMessageId(title) {
            return `status-message-${title.toLowerCase().replace(/\s/g, '-')}`;
        }

        // --- FUNGSI HEADER UNIVERSAL DENGAN USERNAME ---
        function createHeader(title, backPage) {
             const username = currentUser ? currentUser.username : 'Guest';
             const role = currentUser ? currentUser.role : 'User';
             
             return `
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-700 pb-3" id="header-${title.toLowerCase().replace(/\s/g, '-')}">
                    <div class="flex items-center mb-3 md:mb-0">
                        <button onclick="navigate('${backPage}')" class="text-gray-400 hover:text-green-400 transition mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                        </button>
                        <div>
                            <h1 class="text-2xl font-bold text-green-400">${title}</h1>
                            <span id="${getStatusMessageId(title)}" class="text-xs text-gray-500 block mt-1">Siap mencatat</span>
                        </div>
                    </div>
                    <div class="flex items-center text-sm text-gray-400 bg-zinc-800 px-3 py-1.5 rounded-lg border border-zinc-700">
                        <span class="mr-2">User: <span class="font-bold text-green-400">${username}</span> <span class="text-xs text-gray-500">(${role})</span></span>
                        <button onclick="handleLogout()" title="Logout" class="ml-2 p-1 text-gray-400 hover:text-red-500 transition border-l border-gray-600 pl-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                        </button>
                    </div>
                </header>
            `;
        }

        // --- 4. TAMPILAN DASHBOARD ---
        function createDashboardView() {
            const username = currentUser ? currentUser.username : '...';
            const role = currentUser ? currentUser.role : '...';

            return `
                <div class="p-6">
                    <header class="flex justify-between items-center mb-10">
                        <div class="flex items-center">
                            <svg class="w-8 h-8 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10M10 7v10M16 7v10M20 4v16a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h12a2 2 0 012 2z"></path>
                            </svg>
                            <h1 class="text-3xl font-bold text-gray-100 uppercase">Control Palet Hanwa</h1>
                        </div>
                        <div class="flex items-center text-sm text-gray-400 bg-zinc-800 px-4 py-2 rounded-lg">
                            <span class="mr-3 hidden sm:inline">User: <span class="font-bold text-green-400">${username}</span> (${role})</span>
                            <button onclick="handleLogout()" title="Logout" class="ml-2 p-1 rounded-full hover:bg-zinc-700 transition text-red-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </button>
                        </div>
                    </header>
                    
                    <div id="critical-stock-alert-container" class="mb-6"></div>

                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
                        <div onclick="navigate('masterPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10m-4-11l-4 2.12V17M16 12l4 2.12V17"></path></svg>
                            <div class="text-center"><h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Master Palet</h2><p class="text-sm text-gray-400">Data Induk Palet</p></div>
                        </div>
                        <div onclick="navigate('stockPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 12V3h16v9m-4-4l-4 4-4-4m8 8h-8v4h8v-4z"></path></svg>
                            <div class="text-center"><h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Stock Palet</h2><p class="text-sm text-gray-400">Ringkasan Stok Palet</p></div>
                        </div>
                        <div onclick="navigate('transaksiPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14m-1.447 3.382l-.675.337M4 12a7 7 0 1014 0 7 7 0 01-14 0z"></path></svg>
                            <div class="text-center"><h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Transaksi Palet</h2><p class="text-sm text-gray-400">Log Pergerakan Palet</p></div>
                        </div>
                        <div onclick="navigate('analyticsDashboard')" class="menu-card rounded-xl p-8 shadow-xl">
                             <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"></path></svg>
                            <div class="text-center"><h2 class="text-xl font-bold uppercase mb-1 text-gray-100">Dashboard Analitik</h2><p class="text-sm text-gray-400">Grafik & Wawasan Palet</p></div>
                        </div>
                        <div onclick="navigate('historyPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <div class="text-center"><h2 class="text-xl font-bold uppercase mb-1 text-gray-100">History Palet</h2><p class="text-sm text-gray-400">Log Transaksi Palet</p></div>
                        </div>
                        <div onclick="navigate('stoPalet')" class="menu-card rounded-xl p-8 shadow-xl">
                            <svg class="icon w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            <div class="text-center"><h2 class="text-xl font-bold uppercase mb-1 text-gray-100">STO Palet</h2><p class="text-sm text-gray-400">Stock Taking Palet</p></div>
                        </div>
                    </div>
                    <footer class="mt-12 text-center text-xs text-grey-600">
                        Aplikasi Kontrol Palet (v4.6 Grafik Bulan Berjalan) - Elaborated by SOPARI-HSSI0293
                    </footer>
                </div>
            `;
        }
        
        // --- 5. SETUP GOOGLE SHEET URLS ---
        const GOOGLE_SHEET_ID = '1YiIDIa0Ysi-O0k4askOtd8Qf66KnQuJxlLMngDlqM1A'; 
        const MASTER_SHEET_NAME = 'MASTER PALET'; 
        const STOCK_SHEET_NAME = 'Ringkasan Stok Palet'; 
        const TRANSACTION_SHEET_NAME = 'Log Transaksi Palet Batch'; 
        const USERCONTROL_SHEET_NAME = 'Usercontrol';
        const AMBANG_BATAS_SHEET_NAME = 'Ambang Batas'; 
        const RANGE = 'A:H'; 
        const HISTORY_RANGE = 'A:K'; 

        const MASTER_PALLET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${MASTER_SHEET_NAME}&range=${RANGE}`;
        const STOCK_PALLET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${STOCK_SHEET_NAME}&range=${RANGE}`;
        const HISTORY_PALLET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${TRANSACTION_SHEET_NAME}&range=${HISTORY_RANGE}`;
        const USERCONTROL_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${USERCONTROL_SHEET_NAME}&range=A:C`;
        const AMBANG_BATAS_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${AMBANG_BATAS_SHEET_NAME}&range=A:C`;
        
        const MOCK_API_DEPLOY_URL = 'https://script.google.com/macros/s/AKfycbwiq9RP1jZykmw8a4W1PNgoUgfekOxCkAiHhnLtzFX8YB1I8TTPnzgkhNYQZH6I-MZJ/exec'; 

        // --- 6. FUNGSI FETCH DATA ---
        async function fetchSheetData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Status ${response.status}`);
                const text = await response.text();
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);
                if (data.status !== 'ok') throw new Error(`Query error: ${data.errors ? data.errors[0].message : 'Unknown error'}`);
                return parseGVizData(data);
            } catch (error) {
                console.error("Kesalahan saat mengambil data Google Sheet:", error, url);
                throw error;
            }
        }
        
        function parseGVizData(data) {
            const columns = data.table.cols.map(col => ({
                id: col.id,
                label: (col.label || col.id).toUpperCase().trim()  
            })).filter(col => col.label); 

            const rows = data.table.rows;
            const result = [];

            if (rows.length > 0) {
                for (const row of rows) {
                    const rowObject = {};
                    for (let i = 0; i < columns.length; i++) {
                        const colLabel = columns[i].label;
                        rowObject[colLabel] = row.c[i] ? (row.c[i].f || row.c[i].v) : '';
                    }
                    result.push(rowObject);
                }
            }
            return { data: result, headers: columns.map(c => c.label) };
        }
        
        async function fetchMasterData() {
            if (isMasterDataFetched) return;
            try {
                const parsedData = await fetchSheetData(MASTER_PALLET_URL);
                masterPalletData = parsedData.data;
                masterPalletHeaders = parsedData.headers;
                isMasterDataFetched = true;
            } catch (error) {
                console.error("Gagal memuat Master Data:", error);
                isMasterDataFetched = false; 
            }
        }

        async function fetchHistoryData() {
            if (isHistoryDataFetched) return;
            try {
                const parsedData = await fetchSheetData(HISTORY_PALLET_URL);
                historyPalletData = parsedData.data;
                historyPalletHeaders = parsedData.headers;
                isHistoryDataFetched = true;
            } catch (error) {
                console.error("Gagal memuat History Data:", error);
                isHistoryDataFetched = false;
            }
        }

        async function fetchAmbangBatasData() {
            if (isAmbangBatasDataFetched) return;
            try {
                const parsedData = await fetchSheetData(AMBANG_BATAS_URL);
                ambangBatasData = parsedData.data;
                isAmbangBatasDataFetched = true;
            } catch (error) {
                console.error("Gagal memuat Ambang Batas Data:", error);
                isAmbangBatasDataFetched = false;
            }
        }


        // --- LOGIC UNTUK LOGIN ---
        function createLoginView() {
            return `
                <div class="login-view app-view">
                    <div class="login-card w-full max-w-sm p-8 rounded-lg shadow-2xl">
                        <div class="flex items-center justify-center mb-6">
                            <svg class="w-10 h-10 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10M10 7v10M16 7v10M20 4v16a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h12a2 2 0 012 2z"></path></svg>
                            <h1 class="text-2xl font-bold text-gray-100 uppercase">Control Palet</h1>
                        </div>
                        <form id="login-form" onsubmit="handleLogin(event)">
                            <div class="mb-4">${createFormInput('Username', 'loginUsername', 'text', true, 'Masukkan username...')}</div>
                            <div class="mb-6">${createFormInput('Password', 'loginPassword', 'password', true, 'Masukkan password...')}</div>
                            <div id="login-error-message" class="hidden p-3 rounded-lg text-sm mb-4 font-medium bg-red-800 text-white" role="alert"></div>
                            <button type="submit" id="login-submit-btn" class="btn-primary w-full bg-green-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-700 transition">Login</button>
                        </form>
                    </div>
                </div>
            `;
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const usernameEl = document.getElementById('loginUsername');
            const passwordEl = document.getElementById('loginPassword');
            const errorBox = document.getElementById('login-error-message');
            const submitBtn = document.getElementById('login-submit-btn');

            if (!usernameEl || !passwordEl || !errorBox || !submitBtn) return;
            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            
            if (!username || !password) {
                errorBox.textContent = "Username dan Password tidak boleh kosong.";
                errorBox.classList.remove('hidden');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = "Memverifikasi...";
            errorBox.classList.add('hidden');

            try {
                const parsedData = await fetchSheetData(USERCONTROL_URL);
                const { data, headers } = parsedData;
                
                if (headers.length < 3) {
                    errorBox.textContent = "Format sheet salah. Butuh 3 kolom (Username, Password, Role).";
                    errorBox.classList.remove('hidden');
                    submitBtn.disabled = false; submitBtn.textContent = "Login"; return;
                }

                const userCol = headers[0]; 
                const passCol = headers[1]; 

                const foundUser = data.find(user => 
                    String(user[userCol] || '').trim() === username &&
                    String(user[passCol] || '').trim() === password
                );
                
                if (foundUser) {
                    const roleCol = headers[2];
                    currentUser = { 
                        username: String(foundUser[userCol]).trim(), 
                        role: String(foundUser[roleCol] || 'User').trim() 
                    };
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    await initializeFirebase();
                    // Reset cache
                    masterPalletData = []; historyPalletData = []; ambangBatasData = [];
                    isMasterDataFetched = false; isHistoryDataFetched = false; isAmbangBatasDataFetched = false;
                    renderApp('dashboard');
                } else {
                    errorBox.textContent = "Username atau Password salah.";
                    errorBox.classList.remove('hidden');
                    submitBtn.disabled = false; submitBtn.textContent = "Login";
                }
            } catch (error) {
                console.error("Gagal fetch data user:", error);
                errorBox.textContent = "Gagal terhubung ke server. Periksa koneksi Anda.";
                errorBox.classList.remove('hidden');
                submitBtn.disabled = false; submitBtn.textContent = "Login";
            }
        }
        
        function handleLogout() {
            sessionStorage.removeItem('currentUser');
            localStorage.removeItem('currentPage');
            currentUser = null;
            if (auth) signOut(auth);
            auth = null; db = null; userId = null;
            masterPalletData = []; historyPalletData = []; ambangBatasData = [];
            isMasterDataFetched = false; isHistoryDataFetched = false; isAmbangBatasDataFetched = false;
            renderApp('login');
        }
        
        async function checkSessionAndRender() {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                await initializeFirebase();
                renderApp(localStorage.getItem('currentPage') || 'dashboard');
            } else {
                renderApp('login');
            }
        }


        // --- 7. MASTER PALET ---
        const MASTER_PALET_TITLE = 'Master Palet';

        function createMasterPalletView() {
            return `
                <div id="master-pallet-view" class="app-view p-6">
                    ${createHeader(MASTER_PALET_TITLE, 'dashboard')}
                    <h2 class="text-xl font-bold text-gray-300 mb-3 border-b border-gray-800 pb-2">Detail Data Palet</h2>
                    <div id="table-container" class="shadow-lg rounded-xl overflow-x-auto">
                        <table id="pallet-table-master" class="pallet-table min-w-full divide-y divide-gray-700 rounded-xl">
                            <thead class="bg-gray-800"></thead>
                            <tbody class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                    <div id="error-box-master" class="hidden mt-4 p-4 rounded-lg bg-red-800 text-white font-semibold"></div>
                </div>
            `;
        }

        async function fetchMasterPalletData() {
            const statusMessageEl = document.getElementById(getStatusMessageId(MASTER_PALET_TITLE)); 
            const tableHeadEl = document.querySelector('#pallet-table-master thead');
            const tableBodyEl = document.querySelector('#pallet-table-master tbody');
            const errorBoxEl = document.getElementById('error-box-master');
            if (!statusMessageEl || !tableHeadEl || !tableBodyEl) return; 
            
            try {
                tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';
                if (statusMessageEl) statusMessageEl.textContent = 'Memuat data...';

                if (!isMasterDataFetched) await fetchMasterData();
                const data = masterPalletData; 
                const headers = masterPalletHeaders; 
                
                if (data.length === 0) {
                    statusMessageEl.textContent = "Data tidak ditemukan.";
                    tableHeadEl.innerHTML = '';
                    tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data.</td></tr>';
                    return;
                }
                statusMessageEl.textContent = `${data.length} Data Palet Ditemukan`;
                const headerRow = `<tr class="bg-gray-800">${headers.map(header => `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-green-300">${header}</th>`).join('')}</tr>`;
                const filterRow = `<tr class="bg-gray-800">${headers.map(header => `<th class="p-1 align-top"><input type="text" class="w-full px-2 py-1 text-xs bg-zinc-700 border border-zinc-600 rounded text-white placeholder-zinc-400 focus:ring-green-500 focus:border-green-500 master-filter-input" placeholder="Filter..." data-header="${header}" onkeyup="filterMasterPalletTable()"></th>`).join('')}</tr>`;
                
                tableHeadEl.innerHTML = headerRow + filterRow;
                renderMasterPalletTableBody(data);
            } catch (error) {
                 if (statusMessageEl) statusMessageEl.textContent = 'Gagal memuat data.';
                 if (errorBoxEl) { errorBoxEl.textContent = `ðŸš¨ GAGAL MEMUAT DATA: ${error.message}.`; errorBoxEl.classList.remove('hidden'); }
            }
        }
        
        function renderMasterPalletTableBody(data) {
            const tableBodyEl = document.querySelector('#pallet-table-master tbody');
            if (!tableBodyEl) return;
            const headersCount = masterPalletHeaders.length || 10;

            if (data.length === 0) {
                tableBodyEl.innerHTML = `<tr><td colspan="${headersCount}" class="text-center py-4 text-gray-500">Data tidak ditemukan.</td></tr>`;
                return;
            }

            tableBodyEl.innerHTML = data.map((item, index) => {
                const status = item['STATUS'] || '';
                const lokasi = item['LOKASI'] || '';
                const rowColorClass = getRowColorClass(status, lokasi);
                const rowBgClass = (index % 2 === 0 ? 'bg-zinc-800' : 'bg-zinc-700');
                return `<tr class="${rowBgClass} ${rowColorClass}">${masterPalletHeaders.map(header => `<td class="px-6 py-3 whitespace-nowrap text-sm">${item[header] || '-'}</td>`).join('')}</tr>`;
            }).join('');
        }
        
        function filterMasterPalletTable() {
            const filterInputs = document.querySelectorAll('#pallet-table-master .master-filter-input');
            const filters = {};
            filterInputs.forEach(input => {
                const header = input.dataset.header;
                const value = input.value.toUpperCase().trim();
                if (value) filters[header] = value;
            });

            const filterKeys = Object.keys(filters);
            let filteredData = masterPalletData; 
            if (filterKeys.length > 0) {
                filteredData = masterPalletData.filter(item => {
                    return filterKeys.every(header => {
                        const itemValue = String(item[header] || '').toUpperCase();
                        return itemValue.includes(filters[header]);
                    });
                });
            }
            renderMasterPalletTableBody(filteredData);
        }

        function getRowColorClass(status, lokasi) {
            const s = String(status).toUpperCase().trim();
            const l = String(lokasi).toUpperCase().trim();
            if (s === 'KOSONG' && l === 'AREA PALET') return 'color-green'; 
            if (s === 'TERISI' && (l === 'AREA PRODUCT' || l === 'GUDANG')) return 'color-orange'; 
            if (s === 'TERISI' && l === 'CUSTOMER') return 'color-red'; 
            return 'text-gray-200'; 
        }
        
        // --- 8. STOCK PALET ---
        const STOCK_PALET_TITLE = 'Stock Palet';
        function createStockPalletView() {
            return `
                <div id="stock-pallet-view" class="app-view p-6">
                    ${createHeader(STOCK_PALET_TITLE, 'dashboard')}
                    <h2 class="text-xl font-bold text-gray-300 mb-4 border-b border-gray-800 pb-2">Ringkasan Stok Palet</h2>
                    <div id="stock-summary-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"></div>
                    <h2 class="text-xl font-bold text-gray-300 mb-3 border-b border-gray-800 pb-2">Detail Data Ringkasan</h2>
                    <div id="table-container-stock" class="shadow-lg rounded-xl overflow-x-auto">
                        <table id="pallet-table-stock" class="pallet-table min-w-full divide-y divide-gray-700 rounded-xl">
                            <thead class="bg-gray-800"><tr></tr></thead>
                            <tbody class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                    <div id="error-box-stock" class="hidden mt-4 p-4 rounded-lg bg-red-800 text-white font-semibold"></div>
                </div>
            `;
        }

        async function fetchStockPalletData() {
            const statusMessageEl = document.getElementById(getStatusMessageId(STOCK_PALET_TITLE));
            const summaryContainerEl = document.getElementById('stock-summary-container');
            const tableHeaderEl = document.querySelector('#pallet-table-stock thead tr');
            const tableBodyEl = document.querySelector('#pallet-table-stock tbody');
            if (!statusMessageEl || !summaryContainerEl || !tableHeaderEl || !tableBodyEl) return; 

            summaryContainerEl.innerHTML = createSummaryCardPlaceholder('Memuat...', 'Total Palet Hanwa');
            tableHeaderEl.innerHTML = '';
            tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';
            
            try {
                const parsedData = await fetchSheetData(STOCK_PALLET_URL);
                const { data, headers } = parsedData;
                
                if (data.length === 0) {
                    statusMessageEl.textContent = "Data tidak ditemukan.";
                    tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data.</td></tr>';
                    summaryContainerEl.innerHTML = createSummaryCardPlaceholder(0, 'Total Palet Hanwa');
                    return;
                }
                statusMessageEl.textContent = `${data.length} Baris Ringkasan Ditemukan`;
                const totalIndex = headers.length > 0 ? headers.findIndex(h => h.toUpperCase().includes('TOTAL')) : -1;
                let grandTotal = 0;
                data.forEach(item => {
                    const totalValue = totalIndex >= 0 ? parseFloat(String(Object.values(item)[totalIndex]).replace(/[^0-9.,]/g, '').replace(',', '.') || 0) : 0;
                    grandTotal += totalValue;
                });

                summaryContainerEl.innerHTML = createSummaryCard(grandTotal.toLocaleString('id-ID'), 'Total Palet Hanwa', 'text-green-400');
                tableHeaderEl.innerHTML = headers.map(header => `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-green-300">${header}</th>`).join('');
                tableBodyEl.innerHTML = data.map((item, index) => {
                    const rowBgClass = (index % 2 === 0 ? 'bg-zinc-800' : 'bg-zinc-700');
                    return `<tr class="${rowBgClass} text-gray-200">${headers.map(header => `<td class="px-6 py-3 whitespace-nowrap text-sm">${item[header] || '-'}</td>`).join('')}</tr>`;
                }).join('');
            } catch (error) {
                 if (statusMessageEl) statusMessageEl.textContent = 'Gagal memuat data.';
            }
        }

        // --- 9. TRANSAKSI PALET ---
        const TRANSACTION_PALET_TITLE = 'Transaksi Palet';

        function createTransactionPalletView() {
            const today = new Date().toISOString().split('T')[0];
            return `
                <div id="transaction-pallet-view" class="app-view p-6 max-w-4xl mx-auto">
                    ${createHeader(TRANSACTION_PALET_TITLE, 'dashboard')}
                    <div class="bg-zinc-800 p-6 sm:p-8 rounded-xl shadow-2xl">
                        <p class="text-sm text-gray-400 mb-6">Gunakan formulir ini untuk mencatat pergerakan <span class="font-bold text-green-300">beberapa</span> palet sekaligus.</p>
                        <div id="transaction-message-box" class="hidden p-3 rounded-lg text-sm mb-4 font-medium" role="alert"></div>
                        <form id="transaction-form" onsubmit="submitTransaction(event)">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <div>${createFormSelect('Nama Palet', 'namaPalet', [], true, 'updateSizePallet')}</div>
                                <div>${createFormSelect('Size Palet', 'sizePalet', [], true, 'renderPalletIdCards')}</div>
                                <div>${createFormInput('Tanggal Transaksi', 'tanggalTransaksi', 'date', true, '', today)}</div>
                                <div>${createFormSelect('Jenis Transaksi', 'jenisTransaksi', [
                                    { value: 'DIGUNAKAN PRODUKSI', label: 'di Gunakan Produksi' },
                                    { value: 'KELUAR HANWA', label: 'Keluar Hanwa (Pengiriman)' },
                                    { value: 'MASUK HANWA', label: 'Masuk Hanwa (Penerimaan)' }
                                ], true)}</div>
                                <div class="md:col-span-2">${createFormSelect('Kondisi Palet', 'kondisi', [
                                    { value: 'Baik', label: 'Baik' },
                                    { value: 'Rusak Ringan', label: 'Rusak Ringan' },
                                    { value: 'Rusak Berat', label: 'Rusak Berat' }
                                ], true)}</div>
                            </div>
                            <div class="mt-8">
                                <h3 class="text-lg font-bold text-gray-300 mb-3 border-b border-gray-700 pb-1">1. Pilih ID Palet Tersedia <span id="selected-count" class="text-green-400 text-sm font-normal">(0 Palet Dipilih)</span></h3>
                                <div id="pallet-id-card-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3">
                                    <p class="text-gray-500 col-span-full" id="id-card-status">Pilih Nama Palet dan Size Palet terlebih dahulu.</p>
                                </div>
                            </div>
                            <div class="mt-6 p-4 bg-gray-700 rounded-lg border border-green-500">
                                <h4 class="text-sm font-semibold text-green-300 mb-2">2. ID Palet yang akan Diproses:</h4>
                                <div id="selected-ids-display" class="flex flex-wrap gap-2 min-h-[2.5rem]"><span class="text-gray-400 text-sm">Belum ada palet yang dipilih.</span></div>
                            </div>
                            <div class="mt-8 pt-4 border-t border-gray-700 flex justify-end">
                                <button type="submit" id="submit-btn" class="btn-primary bg-green-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-700 transition"><span id="submit-btn-text">Kirim Transaksi</span> (<span id="submit-count">0</span> Palet)</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        async function fetchMasterDataForTransaction() {
            const statusMessageEl = document.getElementById(getStatusMessageId(TRANSACTION_PALET_TITLE)); 
            const namaPaletEl = document.getElementById('namaPalet');
            if (!namaPaletEl) return;
            
            try {
                namaPaletEl.innerHTML = '<option value="" disabled selected>Memuat data...</option>';
                namaPaletEl.disabled = true;
                if (!isMasterDataFetched) await fetchMasterData();
                const data = masterPalletData;
                
                if (data.length === 0) {
                    if(statusMessageEl) statusMessageEl.textContent = "Data Master Palet kosong.";
                    return;
                }
                const uniqueNames = [...new Set(data.map(item => String(item['NAMA PALET']).trim()).filter(name => name))];
                const options = uniqueNames.map(name => ({ value: name, label: name }));
                namaPaletEl.innerHTML = createOptionHtml(options, 'Pilih Nama Palet');
                namaPaletEl.disabled = false;
                if(statusMessageEl) statusMessageEl.textContent = `Data Master siap (${data.length} entri)`;
            } catch (error) {
                 if (statusMessageEl) statusMessageEl.textContent = 'Gagal memuat data master.';
            }
        }
        
        function updateSizePallet() {
            const namaPaletEl = document.getElementById('namaPalet');
            const sizePaletEl = document.getElementById('sizePalet');
            if (!namaPaletEl || !sizePaletEl) return;
            const namaPalet = namaPaletEl.value.trim();
            sizePaletEl.innerHTML = createOptionHtml([], 'Pilih Size Palet');
            sizePaletEl.disabled = true;
            selectedPalletIds = []; updateSelectedDisplay(); renderPalletIdCards(); 

            if (!namaPalet) return;
            const filteredBySize = masterPalletData.filter(item => String(item['NAMA PALET']).trim() === namaPalet);
            const uniqueSizes = [...new Set(filteredBySize.map(item => String(item['SIZE']).trim()).filter(size => size))];
            const options = uniqueSizes.map(size => ({ value: size, label: size }));
            
            if (options.length === 0) {
                 sizePaletEl.innerHTML = createOptionHtml([], 'Tidak ada Size');
                 return;
            }
            sizePaletEl.innerHTML = createOptionHtml(options, 'Pilih Size Palet');
            sizePaletEl.disabled = false;
        }

        function renderPalletIdCards() {
            const namaPaletEl = document.getElementById('namaPalet');
            const sizePaletEl = document.getElementById('sizePalet');
            const container = document.getElementById('pallet-id-card-container');
            if (!container) return; 
            
            const namaPalet = namaPaletEl ? namaPaletEl.value.trim() : '';
            const sizePalet = sizePaletEl ? sizePaletEl.value.trim() : '';
            
            container.innerHTML = `<p class="text-gray-500 col-span-full" id="id-card-status">Memfilter ID Palet...</p>`;
            selectedPalletIds = []; updateSelectedDisplay(); 

            if (!namaPalet || !sizePalet) {
                container.innerHTML = '<p class="text-gray-500 col-span-full">Pilih Nama Palet dan Size Palet terlebih dahulu.</p>';
                return;
            }

            const filteredData = masterPalletData.filter(item => 
                String(item['NAMA PALET']).trim() === namaPalet && String(item['SIZE']).trim() === sizePalet
            );
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full">Tidak ditemukan ID Palet.</p>';
                return;
            }
            container.innerHTML = ''; // clear loading msg
            filteredData.forEach(item => {
                const idPalet = item['ID PALET'];
                if (!idPalet) return; 
                const card = document.createElement('div');
                card.id = `card-${idPalet}`;
                card.className = `id-card rounded-lg text-center shadow-md font-mono font-semibold hover:ring-2 hover:ring-green-500 transition`;
                card.textContent = idPalet;
                card.onclick = () => togglePalletSelection(idPalet);
                container.appendChild(card);
            });
        }
        
        function togglePalletSelection(idPalet) {
            const index = selectedPalletIds.indexOf(idPalet);
            const card = document.getElementById(`card-${idPalet}`);
            if (!card) return;
            if (index > -1) {
                selectedPalletIds.splice(index, 1);
                card.classList.remove('selected');
                showMessage('info', `ID Palet ${idPalet} dibatalkan.`);
            } else {
                selectedPalletIds.push(idPalet);
                card.classList.add('selected');
                showMessage('info', `ID Palet ${idPalet} ditambahkan.`);
            }
            updateSelectedDisplay();
        }
        
        function updateSelectedDisplay() {
            const displayEl = document.getElementById('selected-ids-display');
            const submitCountEl = document.getElementById('submit-count');
            const selectedCountEl = document.getElementById('selected-count');
            if (!submitCountEl || !selectedCountEl) return;
            
            submitCountEl.textContent = selectedPalletIds.length;
            selectedCountEl.textContent = `(${selectedPalletIds.length} Palet Dipilih)`;
            if (displayEl) {
                if (selectedPalletIds.length === 0) {
                    displayEl.innerHTML = '<span class="text-gray-400 text-sm">Belum ada palet yang dipilih.</span>';
                } else {
                    displayEl.innerHTML = selectedPalletIds.map(id => `<span class="selected-id-tag font-mono">${id}</span>`).join('');
                }
            }
        }
        
        // --- HELPER UI ---
        function createFormInput(label, id, type, required, placeholder, value = '', disabled = false) {
            return `<label for="${id}" class="block text-sm font-medium text-gray-300 mb-1">${label} ${required ? '<span class="text-red-500">*</span>' : ''}</label>
                <input type="${type}" id="${id}" name="${id}" ${value ? `value="${value}"` : ''} ${required ? 'required' : ''} ${disabled ? 'disabled' : ''} class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:ring-green-500 focus:border-green-500 ${disabled ? 'opacity-50' : ''}" placeholder="${placeholder}">`;
        }
        function createFormSelect(label, id, options, required, onChangeFunc = '') {
            return `<label for="${id}" class="block text-sm font-medium text-gray-300 mb-1">${label} ${required ? '<span class="text-red-500">*</span>' : ''}</label>
                <select id="${id}" name="${id}" ${required ? 'required' : ''} ${onChangeFunc ? `onchange="${onChangeFunc}()"` : ''} class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-green-500 focus:border-green-500">${createOptionHtml(options, `Pilih ${label}`)}</select>`;
        }
        function createOptionHtml(options, defaultLabel) {
             return `<option value="" disabled selected>${defaultLabel}</option>` + options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
        }
        function showMessage(type, message) {
            const box = document.getElementById('transaction-message-box');
            if (!box) return;
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-800', 'bg-green-800', 'bg-blue-800', 'text-white');
            if (type === 'success') box.classList.add('bg-green-800', 'text-white');
            else if (type === 'error') box.classList.add('bg-red-800', 'text-white');
            else box.classList.add('bg-blue-800', 'text-white');
        }
        function createSummaryCard(value, title, colorClass) {
            return `<div class="bg-zinc-800 p-5 rounded-xl shadow-xl border-t-4 border-green-500"><p class="text-sm text-gray-400 font-medium">${title}</p><p class="text-4xl font-extrabold mt-1 ${colorClass}">${value}</p><p class="text-xs text-gray-500 mt-2">Data dari Sheet</p></div>`;
        }
        function createSummaryCardPlaceholder(value, title) {
            return `<div class="bg-zinc-800 p-5 rounded-xl shadow-xl border-t-4 border-gray-500"><p class="text-sm text-gray-400 font-medium">${title}</p><p class="text-4xl font-extrabold mt-1 text-gray-500">${value}</p><p class="text-xs text-gray-600 mt-2">Menunggu...</p></div>`;
        }

        /**
         * submitTransaction
         */
        async function submitTransaction(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('submit-btn');
            const submitBtnTextEl = document.getElementById('submit-btn-text');
            const submitCountEl = document.getElementById('submit-count');
            
            if (!submitBtn) return;
            const formData = new FormData(form);
            
            if (selectedPalletIds.length === 0) {
                showMessage('error', 'âŒ Harap pilih minimal satu ID Palet.');
                return;
            }

            submitBtn.disabled = true;
            submitBtnTextEl.textContent = 'Mengirim...';
            submitCountEl.textContent = selectedPalletIds.length; 
            showMessage('loading', `Mengirim data untuk ${selectedPalletIds.length} palet, mohon tunggu...`);

            const namaPalet = formData.get('namaPalet').trim();
            const sizePalet = formData.get('sizePalet').trim();
            const tanggalTransaksi = formData.get('tanggalTransaksi').trim();
            const jenisTransaksi = formData.get('jenisTransaksi').trim();
            const kondisi = formData.get('kondisi').trim(); 
            const idPaletString = selectedPalletIds.join(',');
            const now = new Date();
            const jamTransaksi = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            // Ambil username yang sedang login
            const activeUser = currentUser ? currentUser.username : (userId || 'Unknown');

            const batchTransaction = {
                'Nama Palet': namaPalet,
                'Size': sizePalet, 
                'Tanggal Transaksi': tanggalTransaksi,
                'Jenis Transaksi': jenisTransaksi,
                'ID Palet': idPaletString, 
                'Jumlah Palet': selectedPalletIds.length,
                'Jam Transaksi': jamTransaksi,
                'Keterangan': kondisi, 
                'USERNAME': activeUser, 
                'Username': activeUser, 
                'username': activeUser, 
                'Submitted By': activeUser
            };

            const transactionsToSend = [batchTransaction];
            const payload = {
                sheetName: TRANSACTION_SHEET_NAME, 
                transactions: transactionsToSend, 
                submittedBy: activeUser, 
                timestamp: now.toLocaleString('id-ID'),
            };

            try {
                await fetch(MOCK_API_DEPLOY_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload), 
                });
                
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                showMessage('success', `âœ… Berhasil mencatat transaksi!`);
                form.reset();
                selectedPalletIds = []; updateSelectedDisplay(); isHistoryDataFetched = false;

                const sizePaletEl = document.getElementById('sizePalet');
                if (sizePaletEl) {
                    sizePaletEl.innerHTML = createOptionHtml([], 'Pilih Size Palet');
                    sizePaletEl.disabled = true;
                }
                const cardContainerEl = document.getElementById('pallet-id-card-container');
                if (cardContainerEl) {
                    cardContainerEl.innerHTML = '<p class="text-gray-500 col-span-full">Pilih Nama Palet dan Size Palet terlebih dahulu.</p>';
                }

            } catch (error) {
                console.error("Kesalahan saat mengirim data:", error);
                showMessage('error', `âŒ Gagal menyimpan data. Detail: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtnTextEl.textContent = 'Kirim Transaksi';
                if(selectedPalletIds.length === 0) submitCountEl.textContent = '0';
            }
        }

        // --- 10. HISTORY PALET ---
        const HISTORY_PALET_TITLE = 'History Palet';
        function createHistoryPalletView() {
            return `
                <div id="history-pallet-view" class="app-view p-6">
                    ${createHeader(HISTORY_PALET_TITLE, 'dashboard')}
                    <div class="mb-4"><label class="block text-sm font-medium text-gray-300 mb-1">Filter berdasarkan ID Palet:</label><input type="text" id="history-filter" onkeyup="filterHistoryTable()" class="w-full max-w-md px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:ring-green-500 focus:border-green-500" placeholder="Ketik ID Palet (contoh: P-001)..."></div>
                    <h2 class="text-xl font-bold text-gray-300 mb-3 border-b border-gray-800 pb-2">Log Transaksi Palet (Batch)</h2>
                    <div id="table-container-history" class="shadow-lg rounded-xl overflow-x-auto">
                        <table id="pallet-table-history" class="pallet-table min-w-full divide-y divide-gray-700 rounded-xl"><thead class="bg-gray-800"><tr></tr></thead><tbody class="divide-y divide-gray-700"></tbody></table>
                    </div>
                    <div id="error-box-history" class="hidden mt-4 p-4 rounded-lg bg-red-800 text-white font-semibold"></div>
                </div>
            `;
        }
        async function fetchHistoryPalletData() {
            const statusMessageEl = document.getElementById(getStatusMessageId(HISTORY_PALET_TITLE)); 
            const tableHeaderEl = document.querySelector('#pallet-table-history thead tr');
            const tableBodyEl = document.querySelector('#pallet-table-history tbody');
            if (!statusMessageEl || !tableHeaderEl || !tableBodyEl) return; 
            
            try {
                tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';
                if(statusMessageEl) statusMessageEl.textContent = 'Memuat data...';
                if (!isHistoryDataFetched) await fetchHistoryData();
                
                const data = historyPalletData; const headers = historyPalletHeaders;
                if (data.length === 0) {
                    statusMessageEl.textContent = "Data tidak ditemukan.";
                    tableHeaderEl.innerHTML = ''; tableBodyEl.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada data.</td></tr>'; return;
                }
                statusMessageEl.textContent = `${data.length} Log Ditemukan`;
                tableHeaderEl.innerHTML = headers.map(header => `<th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-green-300">${header}</th>`).join('');
                renderHistoryTableBody(data);
            } catch (error) {
                if (statusMessageEl) statusMessageEl.textContent = 'Gagal memuat data.';
            }
        }
        function filterHistoryTable() {
            const filterInput = document.getElementById('history-filter');
            if (!filterInput) return;
            const filterValue = filterInput.value.toUpperCase().trim();
            if (!filterValue) { renderHistoryTableBody(historyPalletData); return; }
            const filteredData = historyPalletData.filter(item => String(item['ID PALET'] || '').toUpperCase().includes(filterValue));
            renderHistoryTableBody(filteredData);
        }
        function renderHistoryTableBody(data) {
            const tableBodyEl = document.querySelector('#pallet-table-history tbody');
            if (!tableBodyEl) return;
            if (data.length === 0) {
                tableBodyEl.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">Data tidak ditemukan.</td></tr>`; return;
            }
            tableBodyEl.innerHTML = data.map((item, index) => {
                const rowBgClass = (index % 2 === 0 ? 'bg-zinc-800' : 'bg-zinc-700');
                return `<tr class="${rowBgClass} text-gray-200">${historyPalletHeaders.map(header => `<td class="px-6 py-3 whitespace-nowrap text-sm">${item[header] || '-'}</td>`).join('')}</tr>`;
            }).join('');
        }

        // --- 11. PLACEHOLDER & ANALYTICS ---
        function createPlaceholderView(title, subtitle) {
            return `
                <div class="p-6 app-view">
                    ${createHeader(title, 'dashboard')}
                    <div class="bg-zinc-800 p-8 rounded-xl shadow-lg text-center mt-10">
                        <h2 class="text-xl font-semibold mb-2 text-gray-200">Fitur ${title}</h2>
                        <p class="text-gray-400 mb-4">${subtitle} - Sedang pengembangan.</p>
                        <button onclick="navigate('dashboard')" class="mt-6 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition">Kembali</button>
                    </div>
                </div>
            `;
        }
        
        async function loadDashboardData() {
            const container = document.getElementById('critical-stock-alert-container');
            if (!container) return;
            container.innerHTML = `<div class="p-4 rounded-lg bg-blue-800 text-white font-medium">Mengecek stok kritis...</div>`;
            try {
                await Promise.all([fetchMasterData(), fetchAmbangBatasData()]);
                checkAndDisplayCriticalStock();
            } catch (error) {
                container.innerHTML = `<div class="p-4 rounded-lg bg-red-800 text-white font-medium">Gagal mengecek stok kritis.</div>`;
            }
        }
        
        function checkAndDisplayCriticalStock() {
            const container = document.getElementById('critical-stock-alert-container');
            if (!container) return;
            criticalStockAlerts = []; 
            if (ambangBatasData.length === 0) {
                container.innerHTML = `<div class="p-4 rounded-lg bg-zinc-700 text-white font-medium">Sheet "Ambang Batas" kosong.</div>`; return;
            }
            ambangBatasData.forEach(rule => {
                const namaPalet = String(rule['NAMA PALET'] || '').trim();
                const size = String(rule['SIZE'] || '').trim();
                const stokMinimum = parseInt(rule['STOK MINIMUM'], 10);
                if (!namaPalet || !size || isNaN(stokMinimum)) return; 
                const stokSiapPakai = masterPalletData.filter(item => String(item['NAMA PALET'] || '').trim() === namaPalet && String(item['SIZE'] || '').trim() === size && String(item['STATUS'] || '').toUpperCase() === 'KOSONG' && String(item['LOKASI'] || '').toUpperCase() === 'AREA PALET').length;
                if (stokSiapPakai < stokMinimum) criticalStockAlerts.push({ nama: `${namaPalet} (${size})`, stok: stokSiapPakai, minimum: stokMinimum });
            });
            if (criticalStockAlerts.length > 0) {
                let alertHtml = `<div class="p-4 rounded-lg bg-red-800 border-l-4 border-red-300 text-white"><h3 class="font-bold text-lg mb-2">ðŸš¨ STOK KRITIS!</h3><ul class="list-disc pl-5 space-y-1 text-sm">`;
                criticalStockAlerts.forEach(alert => { alertHtml += `<li>Stok <strong>${alert.nama}</strong>: <strong>${alert.stok}</strong> (Min: ${alert.minimum})</li>`; });
                alertHtml += `</ul></div>`; container.innerHTML = alertHtml;
            } else {
                container.innerHTML = `<div class="p-4 rounded-lg bg-green-800 text-white font-medium">âœ… Stok aman.</div>`;
            }
        }
        
        const ANALYTICS_TITLE = 'Dashboard Analitik';
        function createAnalyticsDashboardView() {
             return `
                <div id="analytics-dashboard-view" class="app-view p-6">
                    ${createHeader(ANALYTICS_TITLE, 'dashboard')}
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="chart-container lg:col-span-2"><h2 class="text-xl font-bold text-gray-300 mb-4 text-center">Analisis Usia Palet di Customer</h2><canvas id="palletAgingChart"></canvas></div>
                        <div class="chart-container"><h2 class="text-xl font-bold text-gray-300 mb-4 text-center">Kondisi Palet (Log)</h2><canvas id="palletConditionChart"></canvas></div>
                        <div class="chart-container"><h2 class="text-xl font-bold text-gray-300 mb-4 text-center">Pergerakan Palet (Bulan Ini)</h2><canvas id="palletVelocityChart"></canvas></div>
                    </div>
                </div>
            `;
        }
        
        async function loadAnalyticsData() {
            const statusMessageEl = document.getElementById(getStatusMessageId(ANALYTICS_TITLE)); 
            if(statusMessageEl) statusMessageEl.textContent = 'Memuat grafik...';
            try {
                await Promise.all([fetchMasterData(), fetchHistoryData()]);
                Object.values(chartInstances).forEach(chart => { if (chart) chart.destroy(); });
                renderPalletAgingChart(); renderPalletConditionChart(); renderPalletVelocityChart();
                if(statusMessageEl) statusMessageEl.textContent = 'Grafik siap.';
            } catch (error) {
                 if(statusMessageEl) statusMessageEl.textContent = 'Gagal memuat grafik.';
            }
        }
        
        function renderPalletAgingChart() {
            const ctx = document.getElementById('palletAgingChart')?.getContext('2d'); if (!ctx) return;
            const bins = { '0-10 Hari': 0, '11-20 Hari': 0, '21-30 Hari': 0, '> 30 Hari': 0 };
            const today = new Date();
            masterPalletData.forEach(item => {
                if (String(item['LOKASI'] || '').toUpperCase() === 'CUSTOMER') {
                    const tglUpdateStr = String(item['TANGGAL UPDATE'] || '');
                    const parts = tglUpdateStr.split('/');
                    if (parts.length === 3) {
                        const updateDate = new Date(parts[2], parts[0] - 1, parts[1]);
                        const diffDays = Math.ceil(Math.abs(today - updateDate) / (1000 * 60 * 60 * 24));
                        if (diffDays <= 10) bins['0-10 Hari']++; else if (diffDays <= 20) bins['11-20 Hari']++; else if (diffDays <= 30) bins['21-30 Hari']++; else bins['> 30 Hari']++;
                    }
                }
            });
            chartInstances.palletAging = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(bins), datasets: [{ label: 'Jumlah Palet', data: Object.values(bins), backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(255, 99, 132, 0.6)'], borderColor: ['rgba(75, 192, 192, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(255, 99, 132, 1)'], borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } }, plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false } });
        }
        function renderPalletConditionChart() {
            const ctx = document.getElementById('palletConditionChart')?.getContext('2d'); if (!ctx) return;
            const conditions = { 'Baik': 0, 'Rusak Ringan': 0, 'Rusak Berat': 0, 'Lainnya': 0 };
            historyPalletData.forEach(item => {
                const kondisi = String(item['KETERANGAN'] || '').trim();
                if (kondisi === 'Baik') conditions['Baik']++; else if (kondisi === 'Rusak Ringan') conditions['Rusak Ringan']++; else if (kondisi === 'Rusak Berat') conditions['Rusak Berat']++; else if (kondisi && kondisi !== '-') conditions['Lainnya']++;
            });
            chartInstances.palletCondition = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(conditions), datasets: [{ data: Object.values(conditions), backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(153, 102, 255, 0.6)'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#fff' } } } } });
        }
        
        function renderPalletVelocityChart() {
            const ctx = document.getElementById('palletVelocityChart')?.getContext('2d'); if (!ctx) return;
            
            // --- MODIFIKASI v4.6: Logika Bulan Berjalan (1 s/d Akhir Bulan) ---
            const today = new Date();
            const currentMonth = today.getMonth(); // 0-11
            const currentYear = today.getFullYear();
            
            // Cari jumlah hari dalam bulan ini
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const dailyData = {};
            const labels = [];
            
            // Generate label 01 - 30/31 untuk bulan ini
            for (let d = 1; d <= daysInMonth; d++) {
                const label = `${(currentMonth + 1).toString().padStart(2, '0')}/${d.toString().padStart(2, '0')}`;
                labels.push(label);
                dailyData[label] = { 'Masuk Hanwa': 0, 'Keluar Hanwa': 0 };
            }
            
            historyPalletData.forEach(item => {
                const tglStr = String(item['TANGGAL TRANSAKSI'] || '');
                const jenis = String(item['JENIS TRANSAKSI'] || '').toUpperCase();
                const jumlah = parseInt(item['JUMLAH PALET'], 10) || 0;
                
                // Parsing tanggal yang robust (Mendukung YYYY-MM-DD dan MM/DD/YYYY)
                let txDate = new Date(tglStr);
                
                // Validasi: Hanya hitung jika tanggal valid DAN berada di bulan & tahun saat ini
                if (!isNaN(txDate) && txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
                    const label = `${(txDate.getMonth() + 1).toString().padStart(2, '0')}/${txDate.getDate().toString().padStart(2, '0')}`;
                    
                    if (dailyData[label]) {
                        if (jenis === 'MASUK HANWA') dailyData[label]['Masuk Hanwa'] += jumlah;
                        else if (jenis === 'KELUAR HANWA') dailyData[label]['Keluar Hanwa'] += jumlah;
                    }
                }
            });
            
            const dataMasuk = labels.map(label => dailyData[label]['Masuk Hanwa']);
            const dataKeluar = labels.map(label => dailyData[label]['Keluar Hanwa']);
            
            chartInstances.palletVelocity = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: labels, 
                    datasets: [
                        { label: 'Masuk Hanwa', data: dataMasuk, borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: true, tension: 0.1 }, 
                        { label: 'Keluar Hanwa', data: dataKeluar, borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: true, tension: 0.1 }
                    ] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } }, 
                    plugins: { 
                        legend: { position: 'top', labels: { color: '#fff' } },
                        // Judul Dinamis
                        title: { display: true, text: `Pergerakan Palet ${today.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}`, color: '#fff', font: { size: 16 } }
                    } 
                } 
            });
        }

        // --- 12. EKSEKUSI ---
        window.onload = () => {
            window.navigate = navigate;
            window.submitTransaction = submitTransaction; 
            window.updateSizePallet = updateSizePallet;
            window.renderPalletIdCards = renderPalletIdCards;
            window.togglePalletSelection = togglePalletSelection; 
            window.filterHistoryTable = filterHistoryTable; 
            window.filterMasterPalletTable = filterMasterPalletTable;
            window.handleLogin = handleLogin;
            window.handleLogout = handleLogout;
            checkSessionAndRender();
        };
    </script>
</body>
</html>
